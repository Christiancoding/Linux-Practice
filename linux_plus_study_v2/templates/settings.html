{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <div class="card bg-secondary">
            <div class="card-header">
                <h2 class="text-center text-info mb-0">
                    <i class="fas fa-cog"></i> Settings
                </h2>
            </div>
            <div class="card-body">
                <!-- Tab Navigation -->
                <ul class="nav nav-tabs mb-4" id="settingsTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="general-tab" data-bs-toggle="tab" data-bs-target="#general" type="button" role="tab">
                            <i class="fas fa-cog"></i> General
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="study-tab" data-bs-toggle="tab" data-bs-target="#study" type="button" role="tab">
                            <i class="fas fa-book"></i> Study
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="vm-tab" data-bs-toggle="tab" data-bs-target="#vm" type="button" role="tab">
                            <i class="fas fa-server"></i> Virtual Machines
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="data-tab" data-bs-toggle="tab" data-bs-target="#data" type="button" role="tab">
                            <i class="fas fa-database"></i> Data
                        </button>
                    </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content" id="settingsTabContent">
                    <!-- General Settings Tab -->
                    <div class="tab-pane fade show active" id="general" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <h5><i class="fas fa-sliders-h"></i> General Settings</h5>
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="debugMode">
                                    <label class="form-check-label" for="debugMode">
                                        Enable Debug Mode
                                    </label>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="pointsPerQuestion" class="form-label">Points per Question</label>
                                    <input type="number" class="form-control bg-dark text-light" id="pointsPerQuestion" value="10" min="1" max="100">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="streakBonus" class="form-label">Streak Bonus (per question)</label>
                                    <input type="number" class="form-control bg-dark text-light" id="streakBonus" value="5" min="0" max="50">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="maxStreakBonus" class="form-label">Max Streak Bonus</label>
                                    <input type="number" class="form-control bg-dark text-light" id="maxStreakBonus" value="50" min="0" max="200">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Study Preferences Tab -->
                    <div class="tab-pane fade" id="study" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <h5><i class="fas fa-graduation-cap"></i> Study Preferences</h5>
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="focusMode">
                                    <label class="form-check-label" for="focusMode">
                                        Enable Focus Mode (Fullscreen on Quiz Start)
                                    </label>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="breakReminder" class="form-label">Break Reminder (every X questions)</label>
                                    <input type="number" class="form-control bg-dark text-light" id="breakReminder" value="10" min="1" max="50">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- VM Settings Tab -->
                    <div class="tab-pane fade" id="vm" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <h5><i class="fas fa-server"></i> Default VM Configuration</h5>
                                
                                <div class="mb-3">
                                    <label for="defaultTemplate" class="form-label">Default OS Template</label>
                                    <select class="form-control bg-dark text-light" id="defaultTemplate">
                                        <option value="ubuntu-22.04">Ubuntu 22.04 LTS</option>
                                        <option value="ubuntu-20.04">Ubuntu 20.04 LTS</option>
                                        <option value="debian-12">Debian 12</option>
                                        <option value="debian-11">Debian 11</option>
                                        <option value="centos-stream-9">CentOS Stream 9</option>
                                        <option value="fedora-39">Fedora 39</option>
                                        <option value="fedora-38">Fedora 38</option>
                                        <option value="arch-linux">Arch Linux</option>
                                        <option value="alpine-linux">Alpine Linux</option>
                                    </select>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="defaultMemory" class="form-label">Default Memory</label>
                                            <div class="input-group">
                                                <input type="number" class="form-control bg-dark text-light" id="defaultMemory" value="2" min="0.5" step="0.1">
                                                <select class="form-control bg-dark text-light" id="defaultMemoryUnit" style="max-width: 80px;">
                                                    <option value="MB">MB</option>
                                                    <option value="GB" selected>GB</option>
                                                    <option value="TB">TB</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="defaultCpus" class="form-label">Default CPU Cores</label>
                                            <input type="number" class="form-control bg-dark text-light" id="defaultCpus" value="2" min="1" max="32">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="defaultDisk" class="form-label">Default Disk Size</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control bg-dark text-light" id="defaultDisk" value="20" min="1">
                                        <select class="form-control bg-dark text-light" id="defaultDiskUnit" style="max-width: 80px;">
                                            <option value="GB" selected>GB</option>
                                            <option value="TB">TB</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="autoDownloadIso" checked>
                                    <label class="form-check-label" for="autoDownloadIso">
                                        Auto-download ISO files
                                    </label>
                                </div>
                                
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="autoStartVM">
                                    <label class="form-check-label" for="autoStartVM">
                                        Auto-start VMs after creation
                                    </label>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <h5><i class="fas fa-download"></i> ISO Management</h5>
                                
                                <div class="mb-3">
                                    <label for="isoDownloadPath" class="form-label">ISO Download Path</label>
                                    <input type="text" class="form-control bg-dark text-light" id="isoDownloadPath" value="/var/lib/vms/isos" readonly>
                                    <small class="form-text text-muted">Location where ISO files are stored</small>
                                </div>
                                
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="isoDownloadsEnabled" checked>
                                    <label class="form-check-label" for="isoDownloadsEnabled">
                                        Enable ISO downloads
                                    </label>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Manage ISO URLs</label>
                                    <button class="btn btn-outline-info btn-sm d-block w-100" onclick="showIsoUrlManager()">
                                        <i class="fas fa-link"></i> Manage Download URLs
                                    </button>
                                </div>
                                
                                <div class="mb-3">
                                    <button class="btn btn-outline-warning btn-sm d-block w-100" onclick="cleanupIsoFiles()">
                                        <i class="fas fa-trash"></i> Cleanup Unused ISOs
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Data Management Tab -->
                    <div class="tab-pane fade" id="data" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <h5><i class="fas fa-database"></i> Data Management</h5>
                                <button class="btn btn-success mb-3" onclick="saveSettings()">
                                    <i class="fas fa-save"></i> Save All Settings
                                </button>
                                
                                <button class="btn btn-outline-info mb-2 d-block w-100" onclick="exportHistory()">
                                    <i class="fas fa-download"></i> Export History
                                </button>
                                <button class="btn btn-outline-danger d-block w-100" onclick="clearHistory()">
                                    <i class="fas fa-trash"></i> Clear All Statistics
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Load settings on page load
document.addEventListener('DOMContentLoaded', function() {
    loadSettings();
});

function saveSettings() {
    const settings = {
        focusMode: document.getElementById('focusMode').checked,
        breakReminder: parseInt(document.getElementById('breakReminder').value),
        debugMode: document.getElementById('debugMode').checked,
        pointsPerQuestion: parseInt(document.getElementById('pointsPerQuestion').value),
        streakBonus: parseInt(document.getElementById('streakBonus').value),
        maxStreakBonus: parseInt(document.getElementById('maxStreakBonus').value),
        vmDefaults: {
            memory: parseFloat(document.getElementById('defaultMemory').value),
            memoryUnit: document.getElementById('defaultMemoryUnit').value,
            cpus: parseInt(document.getElementById('defaultCpus').value),
            disk: parseInt(document.getElementById('defaultDisk').value),
            diskUnit: document.getElementById('defaultDiskUnit').value,
            autoDownloadIso: document.getElementById('autoDownloadIso').checked,
            autoStart: document.getElementById('autoStartVM').checked,
            defaultTemplate: document.getElementById('defaultTemplate').value
        },
        isoDownloads: {
            enabled: document.getElementById('isoDownloadsEnabled').checked,
            downloadPath: document.getElementById('isoDownloadPath').value
        }
    };

    // Validate settings
    if (settings.maxStreakBonus < settings.streakBonus) {
        showAlert('Max Streak Bonus cannot be less than Streak Bonus. Adjusting automatically.', 'warning');
        settings.maxStreakBonus = settings.streakBonus;
        document.getElementById('maxStreakBonus').value = settings.maxStreakBonus;
    }

    // Validate VM settings
    if (settings.vmDefaults.memory <= 0) {
        showAlert('Memory must be greater than 0', 'error');
        return;
    }

    if (settings.vmDefaults.cpus < 1 || settings.vmDefaults.cpus > 32) {
        showAlert('CPU cores must be between 1 and 32', 'error');
        return;
    }

    if (settings.vmDefaults.disk <= 0) {
        showAlert('Disk size must be greater than 0', 'error');
        return;
    }

    fetch('/api/save_settings', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(settings)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Settings saved successfully!', 'success');
            // Update form with any server-side adjustments
            if (data.settings) {
                populateSettings(data.settings);
            }
        } else {
            showAlert('Failed to save settings: ' + (data.error || 'Unknown error'), 'danger');
        }
    })
    .catch(error => {
        console.error('Error saving settings:', error);
        showAlert('Failed to save settings', 'danger');
    });
}

function loadSettings() {
    fetch('/api/load_settings')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.settings) {
                populateSettings(data.settings);
            } else if(data.error) {
                console.error('Failed to load settings:', data.error);
                showAlert('Could not load settings.', 'danger');
            }
        })
        .catch(error => {
            console.error('Error loading settings:', error);
            showAlert('Could not load settings.', 'danger');
        });
}

function populateSettings(settings) {
    // General settings
    document.getElementById('focusMode').checked = settings.focusMode || false;
    document.getElementById('breakReminder').value = settings.breakReminder || 10;
    document.getElementById('debugMode').checked = settings.debugMode || false;
    document.getElementById('pointsPerQuestion').value = settings.pointsPerQuestion || 10;
    document.getElementById('streakBonus').value = settings.streakBonus || 5;
    document.getElementById('maxStreakBonus').value = settings.maxStreakBonus || 50;
    
    // VM settings
    if (settings.vmDefaults) {
        document.getElementById('defaultTemplate').value = settings.vmDefaults.defaultTemplate || 'ubuntu-22.04';
        document.getElementById('defaultMemory').value = settings.vmDefaults.memory || 2;
        document.getElementById('defaultMemoryUnit').value = settings.vmDefaults.memoryUnit || 'GB';
        document.getElementById('defaultCpus').value = settings.vmDefaults.cpus || 2;
        document.getElementById('defaultDisk').value = settings.vmDefaults.disk || 20;
        document.getElementById('defaultDiskUnit').value = settings.vmDefaults.diskUnit || 'GB';
        document.getElementById('autoDownloadIso').checked = settings.vmDefaults.autoDownloadIso !== false;
        document.getElementById('autoStartVM').checked = settings.vmDefaults.autoStart || false;
    }
    
    // ISO settings
    if (settings.isoDownloads) {
        document.getElementById('isoDownloadsEnabled').checked = settings.isoDownloads.enabled !== false;
        document.getElementById('isoDownloadPath').value = settings.isoDownloads.downloadPath || '/var/lib/vms/isos';
    }
}

function showIsoUrlManager() {
    // Create modal for managing ISO URLs
    const modalHTML = `
        <div class="modal fade" id="isoUrlModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content bg-dark">
                    <div class="modal-header">
                        <h5 class="modal-title text-info">
                            <i class="fas fa-link"></i> Manage ISO Download URLs
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p class="text-muted">Configure download URLs for different OS templates:</p>
                        <div id="isoUrlList">
                            <!-- ISO URLs will be loaded here -->
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-success" onclick="addCustomIsoUrl()">
                                <i class="fas fa-plus"></i> Add Custom URL
                            </button>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="saveIsoUrls()">Save URLs</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if present
    const existingModal = document.getElementById('isoUrlModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to DOM
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Load current ISO URLs
    loadIsoUrls();
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('isoUrlModal'));
    modal.show();
}

function loadIsoUrls() {
    fetch('/api/load_settings')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.settings && data.settings.isoDownloads && data.settings.isoDownloads.urls) {
                const urls = data.settings.isoDownloads.urls;
                const container = document.getElementById('isoUrlList');
                container.innerHTML = '';
                
                Object.keys(urls).forEach(key => {
                    const urlItem = createIsoUrlItem(key, urls[key]);
                    container.appendChild(urlItem);
                });
            }
        })
        .catch(error => {
            console.error('Error loading ISO URLs:', error);
            showAlert('Failed to load ISO URLs', 'danger');
        });
}

function createIsoUrlItem(template, url) {
    const div = document.createElement('div');
    div.className = 'mb-3 p-3 border rounded bg-secondary';
    div.innerHTML = `
        <div class="row align-items-center">
            <div class="col-md-3">
                <label class="form-label text-light">${template}</label>
            </div>
            <div class="col-md-8">
                <input type="url" class="form-control bg-dark text-light" 
                       value="${url}" data-template="${template}">
            </div>
            <div class="col-md-1">
                <button class="btn btn-danger btn-sm" onclick="removeIsoUrl('${template}')">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `;
    return div;
}

function addCustomIsoUrl() {
    const template = prompt('Enter template name (e.g., custom-distro):');
    if (template && template.trim()) {
        const url = prompt('Enter download URL:');
        if (url && url.trim()) {
            const container = document.getElementById('isoUrlList');
            const urlItem = createIsoUrlItem(template.trim(), url.trim());
            container.appendChild(urlItem);
        }
    }
}

function removeIsoUrl(template) {
    if (confirm(`Remove ISO URL for ${template}?`)) {
        const item = document.querySelector(`[data-template="${template}"]`).closest('.mb-3');
        if (item) {
            item.remove();
        }
    }
}

function saveIsoUrls() {
    const urlInputs = document.querySelectorAll('#isoUrlList input[data-template]');
    const urls = {};
    
    urlInputs.forEach(input => {
        const template = input.dataset.template;
        const url = input.value.trim();
        if (template && url) {
            urls[template] = url;
        }
    });
    
    // Update settings with new URLs
    fetch('/api/load_settings')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.settings) {
                const settings = data.settings;
                if (!settings.isoDownloads) {
                    settings.isoDownloads = {};
                }
                settings.isoDownloads.urls = urls;
                
                return fetch('/api/save_settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('ISO URLs saved successfully!', 'success');
                const modal = bootstrap.Modal.getInstance(document.getElementById('isoUrlModal'));
                modal.hide();
            } else {
                showAlert('Failed to save ISO URLs', 'danger');
            }
        })
        .catch(error => {
            console.error('Error saving ISO URLs:', error);
            showAlert('Failed to save ISO URLs', 'danger');
        });
}

function cleanupIsoFiles() {
    if (confirm('This will remove unused ISO files to free up disk space. Continue?')) {
        fetch('/api/vm/cleanup_isos', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert(`Cleanup completed. ${data.removed_count || 0} files removed, ${data.space_freed || '0 MB'} freed.`, 'success');
            } else {
                showAlert('Cleanup failed: ' + (data.error || 'Unknown error'), 'danger');
            }
        })
        .catch(error => {
            console.error('Error during cleanup:', error);
            showAlert('Cleanup failed', 'danger');
        });
    }
}

function exportHistory() {
    window.location.href = '/api/export_history';
    showAlert('History export started', 'info');
}

function clearHistory() {
    if (confirm('Are you sure you want to clear ALL study history and statistics? This action cannot be undone.')) {
        fetch('/api/clear_statistics', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('All statistics have been cleared.', 'success');
            } else {
                showAlert('Failed to clear statistics: ' + (data.error || 'Unknown error'), 'danger');
            }
        })
        .catch(error => {
            showAlert('Failed to clear statistics', 'danger');
        });
    }
}
</script>
{% endblock %}
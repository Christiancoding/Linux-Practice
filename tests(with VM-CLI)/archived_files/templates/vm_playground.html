{% extends "base.html" %}

{% block title %}VM Playground - Linux+ Study Game{% endblock %}

{% block content %}
<!-- VM Playground Page -->
<div class="page-content active" id="page-vm">
    <!-- Page Header -->
    <div class="vm-header glass" data-aos="fade-down">
        <div class="header-content">
            <div class="header-text">
                <h1 class="page-title">
                    <i class="fas fa-server text-gradient"></i>
                    Virtual Machine Playground
                </h1>
                <p class="page-subtitle">Deploy, manage, and practice on real Linux VMs</p>
            </div>
            <div class="vm-stats">
                <div class="stat-card" data-aos="zoom-in" data-aos-delay="100">
                    <div class="stat-icon" style="background: var(--gradient-success);">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-info">
                        <span class="stat-value" id="running-vms">0</span>
                        <span class="stat-label">Running</span>
                    </div>
                </div>
                <div class="stat-card" data-aos="zoom-in" data-aos-delay="200">
                    <div class="stat-icon" style="background: var(--gradient-warning);">
                        <i class="fas fa-pause-circle"></i>
                    </div>
                    <div class="stat-info">
                        <span class="stat-value" id="stopped-vms">0</span>
                        <span class="stat-label">Stopped</span>
                    </div>
                </div>
                <div class="stat-card" data-aos="zoom-in" data-aos-delay="300">
                    <div class="stat-icon" style="background: var(--gradient-primary);">
                        <i class="fas fa-server"></i>
                    </div>
                    <div class="stat-info">
                        <span class="stat-value" id="total-vms">0</span>
                        <span class="stat-label">Total VMs</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- VM Workspace -->
    <div class="vm-workspace">
        <!-- VM Management Sidebar -->
        <aside class="vm-sidebar glass" data-aos="fade-right">
            <div class="sidebar-header">
                <h3><i class="fas fa-cube"></i> Virtual Machines</h3>
                <div class="sidebar-actions">
                    <button class="btn-icon" onclick="refreshVMs()" title="Refresh">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <button class="btn-icon btn-primary" onclick="showCreateVM()" title="Create VM">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
            
            <div class="vm-search">
                <i class="fas fa-search"></i>
                <input type="text" placeholder="Search VMs..." onkeyup="filterVMs(this.value)">
            </div>
            
            <div class="vm-list" id="vm-list">
                <div class="loading-state">
                    <div class="spinner"></div>
                    <p>Loading virtual machines...</p>
                </div>
            </div>
            
            <div class="vm-templates">
                <h4><i class="fas fa-magic"></i> Quick Deploy</h4>
                <div class="template-grid">
                    <button class="template-card" onclick="deployTemplate('ubuntu')">
                        <i class="fab fa-ubuntu"></i>
                        <span>Ubuntu 22.04</span>
                    </button>
                    <button class="template-card" onclick="deployTemplate('centos')">
                        <i class="fab fa-centos"></i>
                        <span>CentOS 8</span>
                    </button>
                    <button class="template-card" onclick="deployTemplate('debian')">
                        <i class="fab fa-linux"></i>
                        <span>Debian 11</span>
                    </button>
                    <button class="template-card" onclick="deployTemplate('arch')">
                        <i class="fab fa-linux"></i>
                        <span>Arch Linux</span>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Terminal Interface -->
        <main class="terminal-container glass" data-aos="fade-left">
            <div class="terminal-header">
                <div class="terminal-tabs">
                    <div class="tab active" data-tab="terminal">
                        <i class="fas fa-terminal"></i>
                        <span>Terminal</span>
                    </div>
                    <div class="tab" data-tab="console">
                        <i class="fas fa-desktop"></i>
                        <span>Console</span>
                    </div>
                    <div class="tab" data-tab="logs">
                        <i class="fas fa-file-alt"></i>
                        <span>Logs</span>
                    </div>
                    <div class="tab" data-tab="metrics">
                        <i class="fas fa-chart-line"></i>
                        <span>Metrics</span>
                    </div>
                </div>
                <div class="terminal-controls">
                    <div class="connection-status" id="connection-status">
                        <div class="status-dot"></div>
                        <span>Disconnected</span>
                    </div>
                    <button class="btn-terminal" onclick="clearTerminal()">
                        <i class="fas fa-eraser"></i>
                        Clear
                    </button>
                    <button class="btn-terminal" onclick="downloadTerminalLog()">
                        <i class="fas fa-download"></i>
                        Export
                    </button>
                    <button class="btn-terminal btn-fullscreen" onclick="toggleFullscreen()">
                        <i class="fas fa-expand"></i>
                    </button>
                </div>
            </div>
            
            <!-- Terminal Tab Content -->
            <div class="tab-content active" id="terminal-tab">
                <div class="terminal" id="terminal">
                    <div class="terminal-output" id="terminal-output">
                        <div class="welcome-ascii">
                            <pre class="ascii-art">
    __    _                  _   _   ____  __            
   / /   (_)____  __  ___  _| | | | / /  |/  /           
  / /   / / __ \/ / / / |/_/ |_| |/ / /|_/ /            
 / /___/ / / / / /_/ />  < \__, / / / / /               
/_____/_/_/ /_/\__,_/_/|_| /____/_/_/ /_/               
                                                         
        Virtual Machine Management Terminal              
    ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━         
                                                         
    Select a VM from the sidebar to connect              
    Type 'help' for available commands                    
                            </pre>
                        </div>
                    </div>
                    <div class="terminal-input-line">
                        <span class="prompt" id="terminal-prompt">
                            <span class="prompt-user">guest</span>@<span class="prompt-host">vm-playground</span>:<span class="prompt-path">~</span>$
                        </span>
                        <input type="text" class="terminal-input" id="terminal-input" autocomplete="off" disabled>
                        <div class="cursor"></div>
                    </div>
                </div>
            </div>
            
            <!-- Console Tab Content -->
            <div class="tab-content" id="console-tab">
                <div class="console-container">
                    <iframe id="vm-console" class="vm-console"></iframe>
                    <div class="console-placeholder">
                        <i class="fas fa-desktop fa-3x"></i>
                        <p>Select a VM to view its graphical console</p>
                    </div>
                </div>
            </div>
            
            <!-- Logs Tab Content -->
            <div class="tab-content" id="logs-tab">
                <div class="logs-container">
                    <div class="logs-filter">
                        <select onchange="filterLogs(this.value)">
                            <option value="all">All Logs</option>
                            <option value="system">System</option>
                            <option value="kernel">Kernel</option>
                            <option value="application">Application</option>
                        </select>
                        <input type="text" placeholder="Search logs..." onkeyup="searchLogs(this.value)">
                    </div>
                    <div class="logs-output" id="logs-output">
                        <div class="log-entry info">
                            <span class="log-time">12:34:56</span>
                            <span class="log-level">INFO</span>
                            <span class="log-message">VM Playground initialized</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Metrics Tab Content -->
            <div class="tab-content" id="metrics-tab">
                <div class="metrics-container">
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <h4><i class="fas fa-microchip"></i> CPU Usage</h4>
                            <canvas id="cpu-chart"></canvas>
                            <div class="metric-value">
                                <span id="cpu-usage">0</span>%
                            </div>
                        </div>
                        <div class="metric-card">
                            <h4><i class="fas fa-memory"></i> Memory Usage</h4>
                            <canvas id="memory-chart"></canvas>
                            <div class="metric-value">
                                <span id="memory-usage">0</span>%
                            </div>
                        </div>
                        <div class="metric-card">
                            <h4><i class="fas fa-hdd"></i> Disk I/O</h4>
                            <canvas id="disk-chart"></canvas>
                            <div class="metric-value">
                                <span id="disk-io">0</span> MB/s
                            </div>
                        </div>
                        <div class="metric-card">
                            <h4><i class="fas fa-network-wired"></i> Network</h4>
                            <canvas id="network-chart"></canvas>
                            <div class="metric-value">
                                ↓ <span id="network-down">0</span> KB/s
                                ↑ <span id="network-up">0</span> KB/s
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- VM Details Panel (Floating) -->
        <div class="vm-details-panel glass" id="vm-details-panel" style="display: none;">
            <div class="details-header">
                <h4><i class="fas fa-info-circle"></i> VM Details</h4>
                <button class="btn-close" onclick="hideVMDetails()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="details-content">
                <div class="detail-item">
                    <label>Name</label>
                    <span id="detail-name">-</span>
                </div>
                <div class="detail-item">
                    <label>Status</label>
                    <span id="detail-status" class="status-badge">-</span>
                </div>
                <div class="detail-item">
                    <label>OS</label>
                    <span id="detail-os">-</span>
                </div>
                <div class="detail-item">
                    <label>IP Address</label>
                    <span id="detail-ip">-</span>
                </div>
                <div class="detail-item">
                    <label>CPU</label>
                    <span id="detail-cpu">-</span>
                </div>
                <div class="detail-item">
                    <label>Memory</label>
                    <span id="detail-memory">-</span>
                </div>
                <div class="detail-item">
                    <label>Storage</label>
                    <span id="detail-storage">-</span>
                </div>
                <div class="detail-item">
                    <label>Uptime</label>
                    <span id="detail-uptime">-</span>
                </div>
            </div>
            <div class="details-actions">
                <button class="btn btn-primary btn-sm" onclick="connectToVM()">
                    <i class="fas fa-plug"></i> Connect
                </button>
                <button class="btn btn-secondary btn-sm" onclick="openVMSettings()">
                    <i class="fas fa-cog"></i> Settings
                </button>
            </div>
        </div>
    </div>

    <!-- Quick Actions Bar -->
    <div class="quick-actions glass" data-aos="fade-up">
        <button class="action-btn" onclick="startSelectedVM()" id="start-btn" disabled>
            <i class="fas fa-play"></i>
            <span>Start</span>
        </button>
        <button class="action-btn" onclick="stopSelectedVM()" id="stop-btn" disabled>
            <i class="fas fa-stop"></i>
            <span>Stop</span>
        </button>
        <button class="action-btn" onclick="restartSelectedVM()" id="restart-btn" disabled>
            <i class="fas fa-redo"></i>
            <span>Restart</span>
        </button>
        <button class="action-btn" onclick="snapshotSelectedVM()" id="snapshot-btn" disabled>
            <i class="fas fa-camera"></i>
            <span>Snapshot</span>
        </button>
        <button class="action-btn" onclick="cloneSelectedVM()" id="clone-btn" disabled>
            <i class="fas fa-copy"></i>
            <span>Clone</span>
        </button>
        <button class="action-btn danger" onclick="deleteSelectedVM()" id="delete-btn" disabled>
            <i class="fas fa-trash"></i>
            <span>Delete</span>
        </button>
    </div>
</div>

<!-- Create VM Modal -->
<div id="create-vm-modal" class="modal">
    <div class="modal-content glass">
        <div class="modal-header">
            <h2 class="modal-title"><i class="fas fa-plus-circle"></i> Create New VM</h2>
            <button class="modal-close" onclick="closeModal('create-vm-modal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="create-vm-form">
                <div class="form-group">
                    <label>VM Name</label>
                    <input type="text" id="vm-name" placeholder="my-linux-vm" required>
                </div>
                <div class="form-group">
                    <label>Operating System</label>
                    <select id="vm-os" required>
                        <option value="">Select OS...</option>
                        <option value="ubuntu-22.04">Ubuntu 22.04 LTS</option>
                        <option value="centos-8">CentOS 8</option>
                        <option value="debian-11">Debian 11</option>
                        <option value="fedora-36">Fedora 36</option>
                        <option value="arch">Arch Linux</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>CPU Cores</label>
                        <input type="number" id="vm-cpu" min="1" max="8" value="2" required>
                    </div>
                    <div class="form-group">
                        <label>Memory (GB)</label>
                        <input type="number" id="vm-memory" min="1" max="16" value="4" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Storage (GB)</label>
                    <input type="number" id="vm-storage" min="10" max="100" value="20" required>
                </div>
                <div class="form-group">
                    <label>Network</label>
                    <select id="vm-network">
                        <option value="nat">NAT (Internet Access)</option>
                        <option value="bridge">Bridged (LAN Access)</option>
                        <option value="internal">Internal Only</option>
                    </select>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('create-vm-modal')">Cancel</button>
            <button class="btn btn-primary" onclick="createVM()">
                <i class="fas fa-rocket"></i> Create VM
            </button>
        </div>
    </div>
</div>

<style>
/* VM Playground Specific Styles */
.vm-header {
    padding: 2rem;
    margin-bottom: 2rem;
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 2rem;
}

.vm-stats {
    display: flex;
    gap: 1.5rem;
}

.stat-card {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.stat-icon {
    width: 50px;
    height: 50px;
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.25rem;
}

.stat-info {
    display: flex;
    flex-direction: column;
}

.stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text-primary);
}

.stat-label {
    font-size: 0.875rem;
    color: var(--text-secondary);
}

/* VM Workspace */
.vm-workspace {
    display: grid;
    grid-template-columns: 320px 1fr;
    gap: 2rem;
    min-height: 600px;
    margin-bottom: 2rem;
}

/* VM Sidebar */
.vm-sidebar {
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.sidebar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.sidebar-header h3 {
    margin: 0;
    font-size: 1.125rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.sidebar-actions {
    display: flex;
    gap: 0.5rem;
}

.btn-icon {
    width: 36px;
    height: 36px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    color: var(--text-secondary);
    cursor: pointer;
    transition: var(--transition-base);
}

.btn-icon:hover {
    background: var(--bg-secondary);
    color: var(--text-primary);
    transform: translateY(-2px);
}

.btn-icon.btn-primary {
    background: var(--gradient-primary);
    color: white;
    border: none;
}

/* VM Search */
.vm-search {
    position: relative;
}

.vm-search i {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-muted);
}

.vm-search input {
    width: 100%;
    padding: 0.75rem 1rem 0.75rem 3rem;
    background: var(--bg-tertiary);
    border: 2px solid var(--border-color);
    border-radius: var(--radius-full);
    color: var(--text-primary);
    font-size: 0.95rem;
}

/* VM List */
.vm-list {
    flex: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.vm-card {
    background: var(--bg-tertiary);
    padding: 1rem;
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: var(--transition-base);
    border: 2px solid transparent;
}

.vm-card:hover {
    background: var(--bg-secondary);
    border-color: var(--primary-color);
    transform: translateX(4px);
}

.vm-card.active {
    background: var(--gradient-primary);
    color: white;
    border-color: transparent;
}

.vm-header-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.vm-name {
    font-weight: 600;
}

.vm-status {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.75rem;
    text-transform: uppercase;
}

.status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--text-muted);
}

.vm-status.running .status-dot {
    background: var(--success-color);
    box-shadow: 0 0 8px var(--success-color);
}

.vm-status.stopped .status-dot {
    background: var(--danger-color);
}

.vm-info {
    display: flex;
    gap: 1rem;
    font-size: 0.875rem;
    color: var(--text-secondary);
}

.vm-card.active .vm-info {
    color: rgba(255, 255, 255, 0.8);
}

/* VM Templates */
.vm-templates h4 {
    font-size: 1rem;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.template-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.75rem;
}

.template-card {
    background: var(--bg-tertiary);
    border: 2px solid var(--border-color);
    border-radius: var(--radius-md);
    padding: 1rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
    transition: var(--transition-base);
}

.template-card:hover {
    background: var(--bg-secondary);
    border-color: var(--primary-color);
    transform: translateY(-2px);
}

.template-card i {
    font-size: 1.5rem;
    color: var(--primary-color);
}

.template-card span {
    font-size: 0.875rem;
}

/* Terminal Container */
.terminal-container {
    display: flex;
    flex-direction: column;
    padding: 0;
    overflow: hidden;
}

.terminal-header {
    background: var(--bg-tertiary);
    padding: 1rem 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--border-color);
}

.terminal-tabs {
    display: flex;
    gap: 0.5rem;
}

.tab {
    padding: 0.5rem 1rem;
    background: transparent;
    border: none;
    border-radius: var(--radius-md);
    color: var(--text-secondary);
    cursor: pointer;
    transition: var(--transition-base);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.tab:hover {
    background: var(--bg-secondary);
    color: var(--text-primary);
}

.tab.active {
    background: var(--gradient-primary);
    color: white;
}

.terminal-controls {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.connection-status {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: var(--text-secondary);
}

.connection-status .status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--danger-color);
}

.connection-status.connected .status-dot {
    background: var(--success-color);
    box-shadow: 0 0 8px var(--success-color);
}

.btn-terminal {
    padding: 0.5rem 1rem;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    color: var(--text-secondary);
    cursor: pointer;
    transition: var(--transition-base);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.btn-terminal:hover {
    background: var(--bg-primary);
    color: var(--text-primary);
}

.btn-fullscreen {
    padding: 0.5rem;
}

/* Tab Content */
.tab-content {
    display: none;
    flex: 1;
    overflow: hidden;
}

.tab-content.active {
    display: flex;
    flex-direction: column;
}

/* Terminal */
.terminal {
    flex: 1;
    background: #0a0a0a;
    color: #00ff00;
    font-family: 'JetBrains Mono', monospace;
    padding: 1.5rem;
    overflow-y: auto;
    position: relative;
}

.terminal-output {
    margin-bottom: 1rem;
}

.welcome-ascii {
    text-align: center;
    margin: 2rem 0;
}

.ascii-art {
    color: #00ff00;
    font-size: 0.875rem;
    line-height: 1.2;
    text-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
}

.terminal-input-line {
    display: flex;
    align-items: center;
    position: relative;
}

.prompt {
    margin-right: 0.5rem;
    color: #00ff00;
    font-weight: bold;
}

.prompt-user {
    color: #50fa7b;
}

.prompt-host {
    color: #8be9fd;
}

.prompt-path {
    color: #f1fa8c;
}

.terminal-input {
    background: transparent;
    border: none;
    color: #00ff00;
    font-family: inherit;
    font-size: inherit;
    flex: 1;
    outline: none;
}

.cursor {
    position: absolute;
    width: 8px;
    height: 16px;
    background: #00ff00;
    animation: blink 1s infinite;
}

@keyframes blink {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0; }
}

/* Console Tab */
.console-container {
    flex: 1;
    position: relative;
    background: #000;
}

.vm-console {
    width: 100%;
    height: 100%;
    border: none;
}

.console-placeholder {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    color: var(--text-muted);
}

/* Logs Tab */
.logs-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    padding: 1rem;
}

.logs-filter {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
}

.logs-filter select,
.logs-filter input {
    padding: 0.5rem 1rem;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    color: var(--text-primary);
}

.logs-output {
    flex: 1;
    background: var(--bg-tertiary);
    border-radius: var(--radius-md);
    padding: 1rem;
    overflow-y: auto;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.875rem;
}

.log-entry {
    display: flex;
    gap: 1rem;
    margin-bottom: 0.5rem;
    padding: 0.5rem;
    border-radius: var(--radius-sm);
}

.log-entry.info {
    background: rgba(6, 182, 212, 0.1);
}

.log-entry.warning {
    background: rgba(245, 158, 11, 0.1);
}

.log-entry.error {
    background: rgba(239, 68, 68, 0.1);
}

.log-time {
    color: var(--text-muted);
}

.log-level {
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.75rem;
}

.log-entry.info .log-level {
    color: var(--accent-color);
}

.log-entry.warning .log-level {
    color: var(--warning-color);
}

.log-entry.error .log-level {
    color: var(--danger-color);
}

/* Metrics Tab */
.metrics-container {
    flex: 1;
    padding: 1.5rem;
}

.metrics-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.5rem;
}

.metric-card {
    background: var(--bg-tertiary);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    position: relative;
}

.metric-card h4 {
    font-size: 1rem;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.metric-card canvas {
    width: 100% !important;
    height: 150px !important;
}

.metric-value {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 2rem;
    font-weight: 700;
    color: var(--text-primary);
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
}

/* VM Details Panel */
.vm-details-panel {
    position: fixed;
    top: 50%;
    right: 2rem;
    transform: translateY(-50%);
    width: 320px;
    z-index: 100;
    animation: slideInRight 0.3s ease;
}

.details-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
}

.details-header h4 {
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.btn-close {
    width: 32px;
    height: 32px;
    padding: 0;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    color: var(--text-secondary);
    cursor: pointer;
    transition: var(--transition-base);
}

.btn-close:hover {
    background: var(--danger-color);
    color: white;
    border-color: var(--danger-color);
}

.details-content {
    margin-bottom: 1.5rem;
}

.detail-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 0;
    border-bottom: 1px solid var(--border-color);
}

.detail-item:last-child {
    border-bottom: none;
}

.detail-item label {
    font-weight: 600;
    color: var(--text-secondary);
}

.status-badge {
    padding: 0.25rem 0.75rem;
    border-radius: var(--radius-full);
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
}

.status-badge.running {
    background: rgba(16, 185, 129, 0.2);
    color: var(--success-color);
}

.status-badge.stopped {
    background: rgba(239, 68, 68, 0.2);
    color: var(--danger-color);
}

.details-actions {
    display: flex;
    gap: 0.75rem;
}

/* Quick Actions Bar */
.quick-actions {
    padding: 1.5rem;
    display: flex;
    justify-content: center;
    gap: 1rem;
    flex-wrap: wrap;
}

.action-btn {
    padding: 0.75rem 1.5rem;
    background: var(--bg-tertiary);
    border: 2px solid var(--border-color);
    border-radius: var(--radius-full);
    color: var(--text-secondary);
    cursor: pointer;
    transition: var(--transition-base);
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 500;
}

.action-btn:hover:not(:disabled) {
    background: var(--bg-secondary);
    border-color: var(--primary-color);
    color: var(--text-primary);
    transform: translateY(-2px);
}

.action-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.action-btn.danger:hover:not(:disabled) {
    background: var(--danger-color);
    border-color: var(--danger-color);
    color: white;
}

/* Loading State */
.loading-state {
    text-align: center;
    padding: 3rem;
    color: var(--text-secondary);
}

.spinner {
    width: 40px;
    height: 40px;
    border: 3px solid var(--border-color);
    border-top-color: var(--primary-color);
    border-radius: 50%;
    margin: 0 auto 1rem;
    animation: spin 1s linear infinite;
}

/* Form Styles */
.form-group {
    margin-bottom: 1.5rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: var(--text-primary);
}

.form-group input,
.form-group select {
    width: 100%;
    padding: 0.75rem 1rem;
    background: var(--bg-tertiary);
    border: 2px solid var(--border-color);
    border-radius: var(--radius-md);
    color: var(--text-primary);
    font-size: 1rem;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}

/* Responsive */
@media (max-width: 1200px) {
    .vm-workspace {
        grid-template-columns: 280px 1fr;
    }
    
    .metrics-grid {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 992px) {
    .header-content {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .vm-stats {
        width: 100%;
        justify-content: space-between;
    }
    
    .vm-workspace {
        grid-template-columns: 1fr;
    }
    
    .vm-sidebar {
        order: 2;
    }
    
    .terminal-container {
        order: 1;
        min-height: 500px;
    }
    
    .vm-details-panel {
        position: relative;
        top: auto;
        right: auto;
        transform: none;
        width: 100%;
        margin-top: 2rem;
    }
}

@media (max-width: 768px) {
    .template-grid {
        grid-template-columns: 1fr;
    }
    
    .terminal-tabs {
        overflow-x: auto;
        flex-wrap: nowrap;
    }
    
    .quick-actions {
        gap: 0.5rem;
    }
    
    .action-btn {
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
    }
}
</style>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/vm_playground.js') }}"></script>
<script>
// VM Playground initialization
let selectedVM = null;
let terminalConnected = false;
let vmList = [];

document.addEventListener('DOMContentLoaded', function() {
    initializeVMPlayground();
    loadVMList();
    initializeTabs();
    initializeTerminal();
    initializeMetrics();
});

// Initialize VM Playground
function initializeVMPlayground() {
    // Set up event listeners
    const terminalInput = document.getElementById('terminal-input');
    if (terminalInput) {
        terminalInput.addEventListener('keypress', handleTerminalInput);
    }
    
    // Update connection status
    updateConnectionStatus(false);
}

// Load VM List
async function loadVMList() {
    try {
        const response = await fetch('/api/vm/list');
        const data = await response.json();
        
        if (data.success) {
            vmList = data.vms || [];
            displayVMList(vmList);
            updateStats();
        }
    } catch (error) {
        console.error('Failed to load VMs:', error);
        showMessage('error', 'Failed to load virtual machines');
    }
}

// Display VM List
function displayVMList(vms) {
    const vmListContainer = document.getElementById('vm-list');
    
    if (vms.length === 0) {
        vmListContainer.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-server fa-3x"></i>
                <p>No virtual machines found</p>
                <button class="btn btn-primary btn-sm" onclick="showCreateVM()">
                    Create First VM
                </button>
            </div>
        `;
        return;
    }
    
    vmListContainer.innerHTML = vms.map(vm => `
        <div class="vm-card" onclick="selectVM('${vm.name}')" data-vm="${vm.name}">
            <div class="vm-header-info">
                <span class="vm-name">${vm.name}</span>
                <span class="vm-status ${vm.status}">
                    <span class="status-dot"></span>
                    ${vm.status}
                </span>
            </div>
            <div class="vm-info">
                <span><i class="fas fa-microchip"></i> ${vm.cpu} CPU</span>
                <span><i class="fas fa-memory"></i> ${vm.memory}</span>
            </div>
        </div>
    `).join('');
}

// Select VM
function selectVM(vmName) {
    selectedVM = vmName;
    
    // Update UI
    document.querySelectorAll('.vm-card').forEach(card => {
        card.classList.remove('active');
    });
    
    const selectedCard = document.querySelector(`[data-vm="${vmName}"]`);
    if (selectedCard) {
        selectedCard.classList.add('active');
    }
    
    // Enable action buttons
    enableActionButtons(true);
    
    // Show VM details
    showVMDetails(vmName);
    
    // Connect to terminal
    connectToVM(vmName);
}

// Show VM Details
async function showVMDetails(vmName) {
    const vm = vmList.find(v => v.name === vmName);
    if (!vm) return;
    
    const detailsPanel = document.getElementById('vm-details-panel');
    detailsPanel.style.display = 'block';
    
    // Update details
    document.getElementById('detail-name').textContent = vm.name;
    document.getElementById('detail-status').textContent = vm.status;
    document.getElementById('detail-status').className = `status-badge ${vm.status}`;
    document.getElementById('detail-os').textContent = vm.os || 'Linux';
    document.getElementById('detail-ip').textContent = vm.ip || 'N/A';
    document.getElementById('detail-cpu').textContent = vm.cpu + ' vCPUs';
    document.getElementById('detail-memory').textContent = vm.memory;
    document.getElementById('detail-storage').textContent = vm.storage || '20 GB';
    document.getElementById('detail-uptime').textContent = vm.uptime || 'N/A';
}

// Hide VM Details
function hideVMDetails() {
    document.getElementById('vm-details-panel').style.display = 'none';
}

// Tab Management
function initializeTabs() {
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
            const tabName = tab.dataset.tab;
            switchTab(tabName);
        });
    });
}

function switchTab(tabName) {
    // Update tab buttons
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
    
    // Update tab content
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.getElementById(`${tabName}-tab`).classList.add('active');
}

// Terminal Functions
function initializeTerminal() {
    displayTerminalMessage('Welcome to VM Playground Terminal', 'system');
    displayTerminalMessage('Select a VM to start...', 'info');
}

function handleTerminalInput(event) {
    if (event.key === 'Enter') {
        const input = event.target;
        const command = input.value.trim();
        
        if (command) {
            executeCommand(command);
            input.value = '';
        }
    }
}

async function executeCommand(command) {
    const startTime = Date.now();
    displayTerminalMessage(`$ ${command}`, 'command');
    
    if (!selectedVM || !terminalConnected) {
        displayTerminalMessage('Error: No VM connected', 'error');
        return;
    }
    
    try {
        const response = await fetch('/api/vm/execute', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                vm_name: selectedVM,
                command: command
            })
        });
        
        const data = await response.json();
        const executionTime = (Date.now() - startTime) / 1000;
        
        if (data.success) {
            displayTerminalMessage(data.output, 'output');
            
            // Track VM command execution
            if (typeof trackVMCommand === 'function') {
                trackVMCommand(command, executionTime);
            }
            if (typeof trackFeatureUsage === 'function') {
                trackFeatureUsage('vm_command_executed');
                // Track specific command types
                const commandType = command.split(' ')[0];
                trackFeatureUsage(`vm_command_${commandType}`);
            }
        } else {
            displayTerminalMessage(`Error: ${data.error}`, 'error');
            if (typeof trackFeatureUsage === 'function') {
                trackFeatureUsage('vm_command_error');
            }
        }
    } catch (error) {
        displayTerminalMessage(`Connection error: ${error.message}`, 'error');
    }
}

function displayTerminalMessage(message, type = 'output') {
    const output = document.getElementById('terminal-output');
    const messageDiv = document.createElement('div');
    messageDiv.className = `terminal-message ${type}`;
    messageDiv.textContent = message;
    output.appendChild(messageDiv);
    output.scrollTop = output.scrollHeight;
}

function clearTerminal() {
    const output = document.getElementById('terminal-output');
    output.innerHTML = '';
    displayTerminalMessage('Terminal cleared', 'system');
}

// Connection Management
async function connectToVM(vmName) {
    updateConnectionStatus(false, 'Connecting...');
    const startTime = Date.now();
    
    try {
        const response = await fetch('/api/vm/connect', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ vm_name: vmName })
        });
        
        const data = await response.json();
        
        if (data.success) {
            terminalConnected = true;
            updateConnectionStatus(true);
            document.getElementById('terminal-input').disabled = false;
            displayTerminalMessage(`Connected to ${vmName}`, 'success');
            
            // Track successful VM connection
            if (typeof trackFeatureUsage === 'function') {
                trackFeatureUsage('vm_connected');
                const connectionTime = (Date.now() - startTime) / 1000;
                trackFeatureUsage('vm_connection_speed');
            }
        } else {
            throw new Error(data.error);
        }
    } catch (error) {
        updateConnectionStatus(false, 'Disconnected');
        displayTerminalMessage(`Failed to connect: ${error.message}`, 'error');
        
        // Track connection failures
        if (typeof trackFeatureUsage === 'function') {
            trackFeatureUsage('vm_connection_failed');
        }
    }
}

function updateConnectionStatus(connected, text = null) {
    const status = document.getElementById('connection-status');
    status.className = `connection-status ${connected ? 'connected' : ''}`;
    
    if (text) {
        status.querySelector('span').textContent = text;
    } else {
        status.querySelector('span').textContent = connected ? 'Connected' : 'Disconnected';
    }
}

// VM Actions
function enableActionButtons(enabled) {
    const buttons = ['start-btn', 'stop-btn', 'restart-btn', 'snapshot-btn', 'clone-btn', 'delete-btn'];
    buttons.forEach(id => {
        document.getElementById(id).disabled = !enabled;
    });
}

async function startSelectedVM() {
    if (!selectedVM) return;
    await vmAction('start', selectedVM);
}

async function stopSelectedVM() {
    if (!selectedVM) return;
    await vmAction('stop', selectedVM);
}

async function restartSelectedVM() {
    if (!selectedVM) return;
    await vmAction('restart', selectedVM);
}

async function vmAction(action, vmName) {
    try {
        const response = await fetch(`/api/vm/${action}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ vm_name: vmName })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showMessage('success', `VM ${action} successful`);
            loadVMList(); // Refresh list
        } else {
            throw new Error(data.error);
        }
    } catch (error) {
        showMessage('error', `Failed to ${action} VM: ${error.message}`);
    }
}

// Create VM
function showCreateVM() {
    document.getElementById('create-vm-modal').classList.add('active');
}

async function createVM() {
    const form = document.getElementById('create-vm-form');
    const formData = {
        name: form.elements['vm-name'].value,
        os: form.elements['vm-os'].value,
        cpu: parseInt(form.elements['vm-cpu'].value),
        memory: parseInt(form.elements['vm-memory'].value),
        storage: parseInt(form.elements['vm-storage'].value),
        network: form.elements['vm-network'].value
    };
    
    try {
        const response = await fetch('/api/vm/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            showMessage('success', 'VM created successfully');
            closeModal('create-vm-modal');
            form.reset();
            loadVMList();
        } else {
            throw new Error(data.error);
        }
    } catch (error) {
        showMessage('error', `Failed to create VM: ${error.message}`);
    }
}

// Quick Deploy Templates
async function deployTemplate(template) {
    const vmName = prompt(`Enter name for ${template} VM:`);
    if (!vmName) return;
    
    try {
        const response = await fetch('/api/vm/deploy-template', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                template: template,
                name: vmName
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showMessage('success', `${template} VM deployed successfully`);
            loadVMList();
        } else {
            throw new Error(data.error);
        }
    } catch (error) {
        showMessage('error', `Failed to deploy template: ${error.message}`);
    }
}

// Update Stats
function updateStats() {
    const running = vmList.filter(vm => vm.status === 'running').length;
    const stopped = vmList.filter(vm => vm.status === 'stopped').length;
    const total = vmList.length;
    
    document.getElementById('running-vms').textContent = running;
    document.getElementById('stopped-vms').textContent = stopped;
    document.getElementById('total-vms').textContent = total;
}

// Initialize Metrics Charts
function initializeMetrics() {
    // This would connect to real metrics in production
    // For demo, we'll create placeholder charts
    
    const chartConfig = {
        type: 'line',
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { 
                    beginAtZero: true,
                    max: 100,
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                },
                x: {
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                }
            }
        }
    };
    
    // Create placeholder charts
    ['cpu-chart', 'memory-chart', 'disk-chart', 'network-chart'].forEach(id => {
        const canvas = document.getElementById(id);
        if (canvas) {
            new Chart(canvas, {
                ...chartConfig,
                data: {
                    labels: ['', '', '', '', '', ''],
                    datasets: [{
                        data: [0, 0, 0, 0, 0, 0],
                        borderColor: '#7c3aed',
                        borderWidth: 2,
                        fill: false
                    }]
                }
            });
        }
    });
}

// Utility Functions
function showMessage(type, text) {
    const message = document.createElement('div');
    message.className = `message ${type} animate-fade-in`;
    message.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
        ${text}
    `;
    
    document.querySelector('.container').insertBefore(message, document.querySelector('.container').firstChild);
    
    setTimeout(() => message.remove(), 5000);
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('active');
}

function refreshVMs() {
    loadVMList();
}

function filterVMs(searchTerm) {
    const filtered = vmList.filter(vm => 
        vm.name.toLowerCase().includes(searchTerm.toLowerCase())
    );
    displayVMList(filtered);
}

// Auto-refresh VMs every 30 seconds
setInterval(loadVMList, 30000);
</script>
{% endblock %}
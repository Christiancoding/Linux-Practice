{% extends "base.html" %}

{% block title %}Settings - Linux+ Study Game{% endblock %}

{% block content %}
<!-- Settings Page -->
<div class="page-content active" id="page-settings">
    <!-- Page Header -->
    <div class="page-header" data-aos="fade-down">
        <h1 class="page-title">
            <i class="fas fa-cog text-gradient"></i>
            Settings & Preferences
        </h1>
        <p class="page-subtitle">Customize your learning experience</p>
    </div>

    <!-- Settings Navigation -->
    <div class="settings-nav glass mb-4" data-aos="fade-up">
        <button class="settings-tab active" onclick="switchSettingsTab('appearance')">
            <i class="fas fa-palette"></i> Appearance
        </button>
        <button class="settings-tab" onclick="switchSettingsTab('gameplay')">
            <i class="fas fa-gamepad"></i> Gameplay
        </button>
        <button class="settings-tab" onclick="switchSettingsTab('gamevalues')">
            <i class="fas fa-sliders-h"></i> Game Values
        </button>
        <button class="settings-tab" onclick="switchSettingsTab('profiles')" title="Manage user profiles - create, rename, and switch between different learning profiles">
            <i class="fas fa-user-friends"></i> Profiles
        </button>
        <button class="settings-tab" onclick="switchSettingsTab('notifications')">
            <i class="fas fa-bell"></i> Notifications
        </button>
        <button class="settings-tab" onclick="switchSettingsTab('data')">
            <i class="fas fa-database"></i> Data
        </button>
        <button class="settings-tab" onclick="switchSettingsTab('system')">
            <i class="fas fa-cogs"></i> System
        </button>
        <button class="settings-tab" onclick="switchSettingsTab('achievements')">
            <i class="fas fa-trophy"></i> Achievements
        </button>
    </div>

    <!-- Settings Content -->
    <div class="settings-content">
        <!-- Appearance Settings -->
        <div class="settings-panel active" id="appearance-panel">
            <section class="settings-section glass" data-aos="fade-up">
                <h2 class="section-header">
                    <i class="fas fa-moon"></i> Theme Settings
                </h2>
                <div class="setting-item">
                    <div class="setting-info">
                        <h4>App Theme</h4>
                        <p>Choose your preferred color scheme</p>
                    </div>
                    <div class="setting-control">
                        <div class="theme-selector">
                            <button class="theme-option active" onclick="setTheme('dark')">
                                <i class="fas fa-moon"></i> Dark
                            </button>
                            <button class="theme-option" onclick="setTheme('light')">
                                <i class="fas fa-sun"></i> Light
                            </button>
                            <button class="theme-option" onclick="setTheme('cosmic')">
                                <i class="fas fa-star"></i> Cosmic
                            </button>
                        </div>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <h4>Accent Color</h4>
                        <p>Customize interface accent colors</p>
                    </div>
                    <div class="setting-control">
                        <div class="color-picker-group">
                            <button class="color-option active" style="background: #7c3aed;" onclick="setAccentColor('#7c3aed')"></button>
                            <button class="color-option" style="background: #ec4899;" onclick="setAccentColor('#ec4899')"></button>
                            <button class="color-option" style="background: #06b6d4;" onclick="setAccentColor('#06b6d4')"></button>
                            <button class="color-option" style="background: #10b981;" onclick="setAccentColor('#10b981')"></button>
                            <button class="color-option" style="background: #f59e0b;" onclick="setAccentColor('#f59e0b')"></button>
                            <button class="color-option" style="background: #ef4444;" onclick="setAccentColor('#ef4444')"></button>
                        </div>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <h4>Font Size</h4>
                        <p>Adjust text size for better readability</p>
                    </div>
                    <div class="setting-control">
                        <div class="slider-control">
                            <input type="range" class="slider" id="font-size" min="80" max="120" value="100">
                            <span class="slider-value">100%</span>
                        </div>
                    </div>
                </div>
            </section>

            <section class="settings-section glass" data-aos="fade-up" data-aos-delay="100">
                <h2 class="section-header">
                    <i class="fas fa-desktop"></i> Display Settings
                </h2>
                <div class="setting-item">
                    <div class="setting-info">
                        <h4>Animations</h4>
                        <p>Enable smooth animations and transitions</p>
                    </div>
                    <div class="setting-control">
                        <label class="toggle-switch">
                            <input type="checkbox" id="animations-toggle" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <h4>Reduce Motion</h4>
                        <p>Minimize animations for accessibility</p>
                    </div>
                    <div class="setting-control">
                        <label class="toggle-switch">
                            <input type="checkbox" id="reduce-motion">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <h4>High Contrast</h4>
                        <p>Increase contrast for better visibility</p>
                    </div>
                    <div class="setting-control">
                        <label class="toggle-switch">
                            <input type="checkbox" id="high-contrast">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </section>
        </div>

        <!-- Gameplay Settings -->
        <div class="settings-panel" id="gameplay-panel">
            <section class="settings-section glass" data-aos="fade-up">
                <h2 class="section-header">
                    <i class="fas fa-brain"></i> Quiz Settings
                </h2>
                <div class="setting-item">
                    <div class="setting-info">
                        <h4>Default Question Count</h4>
                        <p>Number of questions per quiz session</p>
                    </div>
                    <div class="setting-control">
                        <select class="form-select" id="question-count">
                            <option value="10">10 Questions</option>
                            <option value="20" selected>20 Questions</option>
                            <option value="30">30 Questions</option>
                            <option value="50">50 Questions</option>
                        </select>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <h4>Time per Question</h4>
                        <p>Default time limit for timed mode</p>
                    </div>
                    <div class="setting-control">
                        <select class="form-select" id="time-limit">
                            <option value="15">15 seconds</option>
                            <option value="30" selected>30 seconds</option>
                            <option value="45">45 seconds</option>
                            <option value="60">60 seconds</option>
                        </select>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <h4>Show Hints</h4>
                        <p>Display helpful hints during quizzes</p>
                    </div>
                    <div class="setting-control">
                        <label class="toggle-switch">
                            <input type="checkbox" id="show-hints" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <h4>Instant Feedback</h4>
                        <p>Show correct answer immediately</p>
                    </div>
                    <div class="setting-control">
                        <label class="toggle-switch">
                            <input type="checkbox" id="instant-feedback" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </section>

            <section class="settings-section glass" data-aos="fade-up" data-aos-delay="100">
                <h2 class="section-header">
                    <i class="fas fa-volume-up"></i> Sound Settings
                </h2>
                <div class="setting-item">
                    <div class="setting-info">
                        <h4>Sound Effects</h4>
                        <p>Enable game sound effects</p>
                    </div>
                    <div class="setting-control">
                        <label class="toggle-switch">
                            <input type="checkbox" id="sound-effects" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <h4>Volume</h4>
                        <p>Adjust sound effect volume</p>
                    </div>
                    <div class="setting-control">
                        <div class="slider-control">
                            <input type="range" class="slider" id="volume" min="0" max="100" value="70">
                            <span class="slider-value">70%</span>
                        </div>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <h4>Success Sounds</h4>
                        <p>Play sound on correct answers</p>
                    </div>
                    <div class="setting-control">
                        <label class="toggle-switch">
                            <input type="checkbox" id="success-sounds" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </section>
        </div>

        <!-- Game Values Settings -->
        <div class="settings-panel" id="gamevalues-panel">
            <section class="settings-section glass" data-aos="fade-up">
                <h2 class="section-header">
                    <i class="fas fa-calculator"></i> Scoring Configuration
                </h2>
                <div class="setting-item">
                    <div class="setting-info">
                        <h4>Points per Correct Answer</h4>
                        <p>Base points awarded for each correct answer</p>
                    </div>
                    <div class="setting-control">
                        <input type="number" class="form-input" id="points-per-correct" min="1" max="100" value="10">
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <h4>Points per Incorrect Answer</h4>
                        <p>Points deducted for incorrect answers (0 = no penalty)</p>
                    </div>
                    <div class="setting-control">
                        <input type="number" class="form-input" id="points-per-incorrect" min="0" max="50" value="0">
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <h4>Hint Penalty</h4>
                        <p>Points deducted when using hints</p>
                    </div>
                    <div class="setting-control">
                        <input type="number" class="form-input" id="hint-penalty" min="0" max="20" value="5">
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <h4>Speed Bonus</h4>
                        <p>Extra points for quick answers</p>
                    </div>
                    <div class="setting-control">
                        <input type="number" class="form-input" id="speed-bonus" min="0" max="20" value="5">
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <h4>Streak Bonus</h4>
                        <p>Points added per question when on a streak</p>
                    </div>
                    <div class="setting-control">
                        <input type="number" class="form-input" id="streak-bonus" min="0" max="20" value="5">
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <h4>Maximum Streak Bonus</h4>
                        <p>Maximum possible streak bonus points</p>
                    </div>
                    <div class="setting-control">
                        <input type="number" class="form-input" id="max-streak-bonus" min="5" max="200" value="50">
                    </div>
                </div>
            </section>

            <section class="settings-section glass" data-aos="fade-up" data-aos-delay="100">
                <h2 class="section-header">
                    <i class="fas fa-fire"></i> Streak Configuration
                </h2>
                <div class="setting-item">
                    <div class="setting-info">
                        <h4>Streak Bonus Threshold</h4>
                        <p>Minimum streak required for bonus points</p>
                    </div>
                    <div class="setting-control">
                        <input type="number" class="form-input" id="streak-bonus-threshold" min="1" max="10" value="3">
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <h4>Streak Bonus Multiplier</h4>
                        <p>Multiplier applied to streak bonus</p>
                    </div>
                    <div class="setting-control">
                        <input type="number" class="form-input" id="streak-bonus-multiplier" min="1" max="5" step="0.1" value="2.0">
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <h4>Daily Streak Threshold</h4>
                        <p>Days required for dedicated learner achievement</p>
                    </div>
                    <div class="setting-control">
                        <input type="number" class="form-input" id="daily-streak-threshold" min="1" max="30" value="3">
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <h4>Weekly Streak Threshold</h4>
                        <p>Days required for weekly streak achievement</p>
                    </div>
                    <div class="setting-control">
                        <input type="number" class="form-input" id="weekly-streak-threshold" min="1" max="30" value="7">
                    </div>
                </div>
            </section>

            <section class="settings-section glass" data-aos="fade-up" data-aos-delay="200">
                <h2 class="section-header">
                    <i class="fas fa-trophy"></i> Achievement Configuration
                </h2>
                <div class="setting-item">
                    <div class="setting-info">
                        <h4>Perfect Quiz Bonus</h4>
                        <p>Extra points for getting all answers correct</p>
                    </div>
                    <div class="setting-control">
                        <input type="number" class="form-input" id="perfect-quiz-bonus" min="0" max="100" value="25">
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <h4>Daily Challenge Bonus</h4>
                        <p>Points for completing daily challenges</p>
                    </div>
                    <div class="setting-control">
                        <input type="number" class="form-input" id="daily-challenge-bonus" min="0" max="200" value="50">
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <h4>Achievement Point Threshold</h4>
                        <p>Points required for point collector achievement</p>
                    </div>
                    <div class="setting-control">
                        <input type="number" class="form-input" id="achievement-point-threshold" min="100" max="2000" value="500">
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <h4>Achievement Question Threshold</h4>
                        <p>Questions required for century club achievement</p>
                    </div>
                    <div class="setting-control">
                        <input type="number" class="form-input" id="achievement-question-threshold" min="10" max="500" value="100">
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <h4>XP Multiplier</h4>
                        <p>Global multiplier for all XP/point values (affects achievements)</p>
                    </div>
                    <div class="setting-control">
                        <input type="number" class="form-input" id="xp-multiplier" min="0.1" max="10" step="0.1" value="1.0">
                    </div>
                </div>
            </section>

            <section class="settings-section glass" data-aos="fade-up" data-aos-delay="300">
                <h2 class="section-header">
                    <i class="fas fa-cogs"></i> Display Settings
                </h2>
                <div class="setting-item">
                    <div class="setting-info">
                        <h4>Excellent Accuracy Threshold</h4>
                        <p>Percentage for excellent performance (green)</p>
                    </div>
                    <div class="setting-control">
                        <input type="number" class="form-input" id="excellent-threshold" min="80" max="100" value="90">%
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <h4>Good Accuracy Threshold</h4>
                        <p>Percentage for good performance (yellow)</p>
                    </div>
                    <div class="setting-control">
                        <input type="number" class="form-input" id="good-threshold" min="50" max="90" value="75">%
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <h4>Passing Percentage</h4>
                        <p>Minimum percentage to pass a quiz</p>
                    </div>
                    <div class="setting-control">
                        <input type="number" class="form-input" id="passing-percentage" min="50" max="80" value="70">%
                    </div>
                </div>
            </section>

            <div class="settings-footer">
                <button class="btn btn-secondary" onclick="resetGameValuesToDefaults()">
                    <i class="fas fa-undo"></i> Reset to Defaults
                </button>
                <button class="btn btn-primary" onclick="saveGameValues()">
                    <i class="fas fa-save"></i> Save Game Values
                </button>
            </div>
        </div>

        <!-- Profiles Settings -->
        <div class="settings-panel" id="profiles-panel">
            <section class="settings-section glass" data-aos="fade-up">
                <h2 class="section-header">
                    <i class="fas fa-user-friends"></i> User Profiles
                </h2>
                
                <!-- Current Profile Display -->
                <div class="setting-item">
                    <div class="setting-info">
                        <h4>Current Profile</h4>
                        <p>Currently active learning profile</p>
                    </div>
                    <div class="setting-control">
                        <div class="current-profile-display">
                            <span id="current-profile-name">Default</span>
                            <span class="profile-stats" id="current-profile-stats">(0 sessions)</span>
                        </div>
                    </div>
                </div>

                <!-- Profile List -->
                <div class="setting-item">
                    <div class="setting-info">
                        <h4>Available Profiles</h4>
                        <p>Manage your learning profiles</p>
                    </div>
                    <div class="setting-control">
                        <div class="profiles-list" id="profiles-list">
                            <div class="profile-loading">Loading profiles...</div>
                        </div>
                    </div>
                </div>

                <!-- Create New Profile -->
                <div class="setting-item">
                    <div class="setting-info">
                        <h4>Create New Profile</h4>
                        <p>Add a new learning profile</p>
                    </div>
                    <div class="setting-control">
                        <div class="new-profile-form">
                            <input type="text" id="new-profile-name" placeholder="Enter profile name (e.g., Study Mode, Work)" maxlength="30" title="Enter a name for your new learning profile">
                            <button class="btn btn-primary" onclick="createNewProfile()" title="Click to create a new profile with the entered name">
                                <i class="fas fa-plus"></i> Create
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <div class="settings-footer">
                <button class="btn btn-info" onclick="loadProfiles()">
                    <i class="fas fa-sync"></i> Refresh Profiles
                </button>
                <button class="btn btn-warning" onclick="exportProfiles()">
                    <i class="fas fa-download"></i> Export Data
                </button>
            </div>
        </div>

        <!-- Notifications Settings -->
        <div class="settings-panel" id="notifications-panel">
            <section class="settings-section glass" data-aos="fade-up">
                <h2 class="section-header">
                    <i class="fas fa-bell"></i> Notification Preferences
                </h2>
                <div class="setting-item">
                    <div class="setting-info">
                        <h4>Study Reminders</h4>
                        <p>Daily reminders to practice</p>
                    </div>
                    <div class="setting-control">
                        <label class="toggle-switch">
                            <input type="checkbox" id="study-reminders">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <h4>Achievement Alerts</h4>
                        <p>Notify when unlocking achievements</p>
                    </div>
                    <div class="setting-control">
                        <label class="toggle-switch">
                            <input type="checkbox" id="achievement-alerts" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <h4>Streak Reminders</h4>
                        <p>Remind to maintain your streak</p>
                    </div>
                    <div class="setting-control">
                        <label class="toggle-switch">
                            <input type="checkbox" id="streak-reminders">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <h4>Reminder Time</h4>
                        <p>When to send daily reminders</p>
                    </div>
                    <div class="setting-control">
                        <input type="time" class="time-input" id="reminder-time" value="18:00">
                    </div>
                </div>
            </section>
        </div>

        <!-- Data Management -->
        <div class="settings-panel" id="data-panel">
            <section class="settings-section glass" data-aos="fade-up">
                <h2 class="section-header">
                    <i class="fas fa-download"></i> Data Management
                </h2>
                <div class="setting-item">
                    <div class="setting-info">
                        <h4>Export Data</h4>
                        <p>Download all your progress data</p>
                    </div>
                    <div class="setting-control">
                        <button class="btn btn-primary" onclick="exportUserData()">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <h4>Import Data</h4>
                        <p>Restore from a previous backup</p>
                    </div>
                    <div class="setting-control">
                        <button class="btn btn-secondary" onclick="importUserData()">
                            <i class="fas fa-upload"></i> Import
                        </button>
                    </div>
                </div>
            </section>

            <section class="settings-section glass danger-zone" data-aos="fade-up" data-aos-delay="100">
                <h2 class="section-header text-danger">
                    <i class="fas fa-exclamation-triangle"></i> Danger Zone
                </h2>
                <div class="setting-item danger">
                    <div class="setting-info">
                        <h4>Reset All Data</h4>
                        <p>Clear all quiz history and stats for ALL profiles (keeps profiles but resets their data)</p>
                        <small class="text-muted">⚠️ This affects all profiles, not just the current one</small>
                    </div>
                    <div class="setting-control">
                        <button class="btn btn-outline-danger" onclick="confirmResetProgress()" title="Reset all quiz data for all profiles">
                            Reset All Data
                        </button>
                    </div>
                </div>
            </section>
        </div>

        <!-- System Settings -->
        <div class="settings-panel" id="system-panel">
            <section class="settings-section glass" data-aos="fade-up">
                <h2 class="section-header">
                    <i class="fas fa-focus"></i> Focus & Productivity
                </h2>
                <div class="setting-item">
                    <div class="setting-info">
                        <h4>Focus Mode</h4>
                        <p>Hide distracting UI elements during quiz sessions</p>
                    </div>
                    <div class="setting-control">
                        <label class="toggle-switch">
                            <input type="checkbox" id="focus-mode-toggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <h4>Break Reminders</h4>
                        <p>Show periodic break reminders during study sessions</p>
                    </div>
                    <div class="setting-control">
                        <label class="toggle-switch">
                            <input type="checkbox" id="break-reminder-toggle" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <h4>Break Reminder Interval</h4>
                        <p>Minutes between break reminder notifications</p>
                    </div>
                    <div class="setting-control">
                        <input type="number" class="form-input" id="break-reminder-interval" min="5" max="60" value="15">
                    </div>
                </div>
            </section>
        </div>

        <!-- Achievement Management -->
        <div class="settings-panel" id="achievements-panel">
            <section class="settings-section glass" data-aos="fade-up">
                <h2 class="section-header">
                    <i class="fas fa-plus-circle"></i> Create Achievement
                </h2>
                <div class="achievement-form">
                    <div class="setting-item">
                        <div class="setting-info">
                            <h4>Achievement Name</h4>
                            <p>Unique name for your custom achievement</p>
                        </div>
                        <div class="setting-control">
                            <input type="text" class="form-input" id="achievement-name" placeholder="My Custom Achievement" maxlength="50">
                        </div>
                    </div>
                    <div class="setting-item">
                        <div class="setting-info">
                            <h4>Description</h4>
                            <p>What the user needs to do to earn this achievement</p>
                        </div>
                        <div class="setting-control">
                            <input type="text" class="form-input" id="achievement-description" placeholder="Complete 50 questions in Advanced category" maxlength="100">
                        </div>
                    </div>
                    <div class="setting-item">
                        <div class="setting-info">
                            <h4>Condition Type</h4>
                            <p>What metric to track for this achievement</p>
                        </div>
                        <div class="setting-control">
                            <select class="form-select" id="achievement-condition-type">
                                <option value="questions">Total Questions Answered</option>
                                <option value="points">Total Points Earned</option>
                                <option value="streaks">Streaks Achieved</option>
                                <option value="days">Days Studied</option>
                            </select>
                        </div>
                    </div>
                    <div class="setting-item">
                        <div class="setting-info">
                            <h4>Condition Value</h4>
                            <p>Target value required to unlock the achievement</p>
                        </div>
                        <div class="setting-control">
                            <input type="number" class="form-input" id="achievement-condition-value" min="1" max="10000" value="100">
                        </div>
                    </div>
                    <div class="setting-item">
                        <div class="setting-info">
                            <h4>XP Reward</h4>
                            <p>Experience points awarded when achievement is unlocked</p>
                        </div>
                        <div class="setting-control">
                            <input type="number" class="form-input" id="achievement-xp-reward" min="1" max="1000" value="100">
                        </div>
                    </div>
                    <div class="setting-item">
                        <div class="setting-control" style="justify-content: flex-end;">
                            <button class="btn btn-primary" onclick="createCustomAchievement()">
                                <i class="fas fa-plus"></i> Create Achievement
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <section class="settings-section glass" data-aos="fade-up" data-aos-delay="100">
                <h2 class="section-header">
                    <i class="fas fa-list"></i> Custom Achievements
                </h2>
                <div id="custom-achievements-list">
                    <div class="achievement-loading">Loading achievements...</div>
                </div>
            </section>
        </div>
    </div>

    <!-- Save Settings Footer -->
    <div class="settings-footer glass" data-aos="fade-up">
        <button class="btn btn-secondary" onclick="resetSettings()">
            <i class="fas fa-undo"></i> Reset to Defaults
        </button>
        <button class="btn btn-primary" onclick="saveSettings()">
            <i class="fas fa-save"></i> Save Changes
        </button>
    </div>
</div>

<style>
/* Settings Page Specific Styles */
.settings-nav {
    display: flex;
    gap: 0.5rem;
    padding: 1rem;
    overflow-x: auto;
    scrollbar-width: thin;
}

.settings-tab {
    padding: 0.75rem 1.5rem;
    background: var(--bg-tertiary);
    border: 2px solid transparent;
    border-radius: var(--radius-full);
    color: var(--text-secondary);
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition-base);
    white-space: nowrap;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.settings-tab:hover {
    background: var(--bg-secondary);
    color: var(--text-primary);
}

.settings-tab.active {
    background: var(--gradient-primary);
    color: white;
    border-color: transparent;
}

.settings-panel {
    display: none;
}

.settings-panel.active {
    display: block;
}

.settings-section {
    padding: 2rem;
    margin-bottom: 2rem;
}

.section-header {
    font-size: 1.25rem;
    margin-bottom: 2rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.setting-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem 0;
    border-bottom: 1px solid var(--border-color);
}

.setting-item:last-child {
    border-bottom: none;
}

.setting-item.danger .setting-info h4 {
    color: var(--danger-color);
}

.setting-info {
    flex: 1;
    max-width: 500px;
}

.setting-info h4 {
    font-size: 1.125rem;
    font-weight: 600;
    margin-bottom: 0.25rem;
    color: var(--text-primary);
}

.setting-info p {
    font-size: 0.875rem;
    color: var(--text-secondary);
    margin: 0;
}

.setting-control {
    display: flex;
    align-items: center;
    gap: 1rem;
}

/* Theme Selector */
.theme-selector {
    display: flex;
    gap: 0.5rem;
    background: var(--bg-tertiary);
    padding: 0.25rem;
    border-radius: var(--radius-full);
}

.theme-option {
    padding: 0.75rem 1.25rem;
    background: transparent;
    border: none;
    border-radius: var(--radius-full);
    cursor: pointer;
    transition: var(--transition-base);
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--text-secondary);
}

.theme-option.active,
.theme-option:hover {
    background: var(--gradient-primary);
    color: white;
    box-shadow: var(--shadow-md);
}

/* Color Picker */
.color-picker-group {
    display: flex;
    gap: 0.5rem;
}

.color-option {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 3px solid transparent;
    cursor: pointer;
    transition: var(--transition-base);
}

.color-option:hover {
    transform: scale(1.1);
}

.color-option.active {
    border-color: white;
    box-shadow: var(--shadow-lg);
}

/* Toggle Switch */
.toggle-switch {
    position: relative;
    display: inline-block;
    width: 60px;
    height: 30px;
}

.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--bg-tertiary);
    transition: var(--transition-base);
    border-radius: var(--radius-full);
}

.toggle-slider::before {
    position: absolute;
    content: '';
    height: 24px;
    width: 24px;
    left: 3px;
    bottom: 3px;
    background: white;
    transition: var(--transition-base);
    border-radius: 50%;
}

.toggle-switch input:checked + .toggle-slider {
    background: var(--gradient-primary);
}

.toggle-switch input:checked + .toggle-slider::before {
    transform: translateX(30px);
}

/* Slider Control */
.slider-control {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.slider {
    width: 150px;
    height: 6px;
    background: var(--bg-tertiary);
    border-radius: var(--radius-full);
    outline: none;
    -webkit-appearance: none;
}

.slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 20px;
    height: 20px;
    background: var(--gradient-primary);
    cursor: pointer;
    border-radius: 50%;
}

.slider::-moz-range-thumb {
    width: 20px;
    height: 20px;
    background: var(--gradient-primary);
    cursor: pointer;
    border-radius: 50%;
}

.slider-value {
    min-width: 50px;
    text-align: right;
    font-weight: 600;
    color: var(--text-primary);
}

/* Form Controls */
.form-select, .time-input {
    padding: 0.75rem 1rem;
    background: var(--bg-tertiary);
    border: 2px solid var(--border-color);
    border-radius: var(--radius-md);
    color: var(--text-primary);
    cursor: pointer;
    transition: var(--transition-base);
}

.form-select:focus, .time-input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 4px rgba(124, 58, 237, 0.1);
}

/* Danger Zone */
.danger-zone {
    border: 2px solid rgba(239, 68, 68, 0.3);
    background: rgba(239, 68, 68, 0.05);
}

/* Settings Footer */
.settings-footer {
    position: sticky;
    bottom: 0;
    padding: 1.5rem;
    display: flex;
    justify-content: space-between;
    gap: 1rem;
    margin-top: 2rem;
    backdrop-filter: blur(20px);
    z-index: 10;
}

/* Responsive */
@media (max-width: 768px) {
    .settings-nav {
        flex-wrap: wrap;
    }
    
    .setting-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
    }
    
    .setting-control {
        width: 100%;
        justify-content: flex-end;
    }
    
    .settings-footer {
        flex-direction: column;
    }
    
    .settings-footer button {
        width: 100%;
    }
}

/* Profile Management Styles */
.current-profile-display {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

#current-profile-name {
    font-weight: bold;
    color: #fff;
    font-size: 1.1em;
}

.profile-stats {
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.9em;
}

.profiles-list {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 8px;
    background: rgba(0, 0, 0, 0.2);
}

.profile-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    transition: background-color 0.3s ease;
}

.profile-item:last-child {
    border-bottom: none;
}

.profile-item:hover {
    background: rgba(255, 255, 255, 0.1);
}

.profile-item.active {
    background: rgba(74, 144, 226, 0.3);
    border-left: 4px solid #4a90e2;
}

.profile-info h5 {
    margin: 0;
    color: #fff;
    font-size: 1em;
}

.profile-info p {
    margin: 2px 0 0 0;
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.85em;
}

.profile-actions {
    display: flex;
    gap: 5px;
}

.profile-actions .btn {
    padding: 5px 10px;
    font-size: 0.8em;
    min-width: auto;
}

.new-profile-form {
    display: flex;
    gap: 10px;
    align-items: center;
}

.new-profile-form input {
    flex: 1;
    padding: 10px;
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 6px;
    background: rgba(255, 255, 255, 0.1);
    color: #fff;
    font-size: 1em;
}

.new-profile-form input::placeholder {
    color: rgba(255, 255, 255, 0.5);
}

.new-profile-form input:focus {
    outline: none;
    border-color: #4a90e2;
    box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.3);
}

.profile-empty {
    text-align: center;
    padding: 20px;
    color: rgba(255, 255, 255, 0.6);
    font-style: italic;
}

.profile-loading {
    text-align: center;
    padding: 20px;
    color: rgba(255, 255, 255, 0.8);
    font-style: italic;
}

.profile-loading::after {
    content: '';
    display: inline-block;
    width: 16px;
    height: 16px;
    margin-left: 10px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top-color: rgba(255, 255, 255, 0.8);
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Achievement Management Styles */
.achievement-form {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 12px;
    padding: 1.5rem;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.achievement-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    margin-bottom: 1rem;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.achievement-info h5 {
    margin: 0 0 0.5rem 0;
    color: var(--text-primary);
    font-weight: 600;
}

.achievement-info p {
    margin: 0 0 0.25rem 0;
    color: var(--text-secondary);
    font-size: 0.9rem;
}

.achievement-meta {
    display: flex;
    gap: 1rem;
    font-size: 0.85rem;
    color: var(--text-secondary);
}

.achievement-actions {
    display: flex;
    gap: 0.5rem;
}

.achievement-status {
    padding: 0.25rem 0.75rem;
    border-radius: 16px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
}

.achievement-status.unlocked {
    background: rgba(34, 197, 94, 0.2);
    color: #22c55e;
}

.achievement-status.locked {
    background: rgba(156, 163, 175, 0.2);
    color: #9ca3af;
}

.achievement-loading {
    text-align: center;
    padding: 2rem;
    color: var(--text-secondary);
    font-style: italic;
}

.achievement-empty {
    text-align: center;
    padding: 2rem;
    color: var(--text-secondary);
}

.form-input {
    padding: 0.75rem 1rem;
    background: var(--bg-tertiary);
    border: 2px solid var(--border-color);
    border-radius: var(--radius-md);
    color: var(--text-primary);
    transition: var(--transition-base);
    width: 200px;
}

.form-input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 4px rgba(124, 58, 237, 0.1);
}

/* System Settings Styles */
.system-panel .setting-item {
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.system-panel .setting-item:last-child {
    border-bottom: none;
}

/* Focus mode indicator */
.focus-mode-active {
    border: 2px solid var(--primary-color);
    box-shadow: 0 0 20px rgba(124, 58, 237, 0.3);
}
</style>
{% endblock %}

{% block scripts %}
<script>
// Settings page functionality
document.addEventListener('DOMContentLoaded', function() {
    console.log('Initializing settings page...');
    
    // Load saved settings first
    loadSettings();
    loadGameValues();
    
    // Initialize all interactive elements
    initializeSliders();
    initializeFontSizeSlider();
    initializeToggles();
    
    // Preload profiles to avoid confusion
    loadProfiles();
    
    console.log('Settings page initialization complete');
});

// Load saved settings
function loadSettings() {
    const settings = JSON.parse(localStorage.getItem('appSettings') || '{}');
    
    // Apply saved theme
    const savedTheme = settings.theme || localStorage.getItem('theme') || 'dark';
    setTheme(savedTheme);
    updateActiveThemeButton(savedTheme);
    
    // Apply saved accent color
    const savedAccentColor = settings.accentColor || '#7c3aed';
    document.documentElement.style.setProperty('--primary-color', savedAccentColor);
    document.documentElement.style.setProperty('--accent-color', savedAccentColor);
    updateActiveColorButton(savedAccentColor);
    
    // Apply saved font size
    const savedFontSize = settings.fontSize || 100;
    const fontSizeSlider = document.getElementById('font-size');
    if (fontSizeSlider) {
        fontSizeSlider.value = savedFontSize;
        document.documentElement.style.setProperty('--base-font-size', savedFontSize + '%');
        updateSliderValue('font-size');
    }
    
    // Load other settings with error handling...
    const questionCountEl = document.getElementById('question-count');
    const timeLimitEl = document.getElementById('time-limit');
    const showHintsEl = document.getElementById('show-hints');
    const instantFeedbackEl = document.getElementById('instant-feedback');
    const soundEffectsEl = document.getElementById('sound-effects');
    const volumeEl = document.getElementById('volume');
    
    if (questionCountEl) questionCountEl.value = settings.questionCount || '20';
    if (timeLimitEl) timeLimitEl.value = settings.timeLimit || '30';
    if (showHintsEl) showHintsEl.checked = settings.showHints !== false;
    if (instantFeedbackEl) instantFeedbackEl.checked = settings.instantFeedback !== false;
    if (soundEffectsEl) soundEffectsEl.checked = settings.soundEffects !== false;
    if (volumeEl) {
        volumeEl.value = settings.volume || 70;
        updateSliderValue('volume');
    }
    
    // Apply animations setting
    const animationsEl = document.getElementById('animations-toggle');
    if (animationsEl) {
        animationsEl.checked = settings.animations !== false;
        document.body.classList.toggle('no-animations', !animationsEl.checked);
    }
    
    // Apply reduce motion setting
    const reduceMotionEl = document.getElementById('reduce-motion');
    if (reduceMotionEl) {
        reduceMotionEl.checked = settings.reduceMotion === true;
        document.body.classList.toggle('reduce-motion', reduceMotionEl.checked);
    }
}

// Switch settings tabs
function switchSettingsTab(tab) {
    // Update active tab
    document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
    event.target.classList.add('active');
    
    // Show corresponding panel
    document.querySelectorAll('.settings-panel').forEach(panel => {
        panel.classList.remove('active');
    });
    document.getElementById(`${tab}-panel`).classList.add('active');
    
    // Load profiles when profiles tab is selected
    if (tab === 'profiles') {
        loadProfiles();
    }
    
    // Load system settings when system panel is shown
    if (tab === 'system') {
        loadSystemSettings();
    }
    
    // Load achievements when achievements panel is shown
    if (tab === 'achievements') {
        loadCustomAchievements();
    }
}

// Initialize sliders
function initializeSliders() {
    const sliders = document.querySelectorAll('.slider');
    sliders.forEach(slider => {
        slider.addEventListener('input', function() {
            updateSliderValue(this.id);
        });
    });
}

// Update slider value display
function updateSliderValue(sliderId) {
    const slider = document.getElementById(sliderId);
    const value = slider.value;
    const valueDisplay = slider.nextElementSibling;
    
    if (valueDisplay && valueDisplay.classList.contains('slider-value')) {
        valueDisplay.textContent = value + '%';
    }
}

// Set theme with proper button state management
function setTheme(themeName) {
    console.log('Setting theme to:', themeName);
    document.documentElement.setAttribute('data-theme', themeName);
    localStorage.setItem('theme', themeName);
    
    // Update theme button active states
    updateActiveThemeButton(themeName);
    
    // Update theme icon if it exists
    const themeIcon = document.getElementById('themeIcon');
    if (themeIcon) {
        themeIcon.className = themeName === 'dark' ? 'fas fa-moon' : 
                             themeName === 'light' ? 'fas fa-sun' : 'fas fa-star';
    }
}

// Update active theme button
function updateActiveThemeButton(themeName) {
    document.querySelectorAll('.theme-option').forEach(btn => {
        btn.classList.remove('active');
        const btnText = btn.textContent.trim().toLowerCase();
        if (btnText.includes(themeName)) {
            btn.classList.add('active');
        }
    });
}

// Set accent color
function setAccentColor(color) {
    console.log('Setting accent color to:', color);
    document.documentElement.style.setProperty('--primary-color', color);
    document.documentElement.style.setProperty('--accent-color', color);
    document.documentElement.style.setProperty('--gradient-primary', `linear-gradient(135deg, ${color}, ${color}88)`);
    
    // Update active state
    updateActiveColorButton(color);
    
    // Save to localStorage immediately
    const settings = JSON.parse(localStorage.getItem('appSettings') || '{}');
    settings.accentColor = color;
    localStorage.setItem('appSettings', JSON.stringify(settings));
}

// Update active color button
function updateActiveColorButton(color) {
    document.querySelectorAll('.color-option').forEach(btn => {
        btn.classList.remove('active');
        const btnColor = btn.style.backgroundColor;
        const btnColorHex = rgbToHex(btnColor);
        if (btnColorHex === color.toLowerCase() || btn.style.background.includes(color)) {
            btn.classList.add('active');
        }
    });
}

// Convert RGB to Hex
function rgbToHex(rgb) {
    if (rgb.startsWith('#')) return rgb.toLowerCase();
    
    const result = rgb.match(/\d+/g);
    if (!result || result.length < 3) return rgb;
    
    const r = parseInt(result[0]);
    const g = parseInt(result[1]);
    const b = parseInt(result[2]);
    
    return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toLowerCase();
}

// Initialize font size slider functionality
function initializeFontSizeSlider() {
    const fontSizeSlider = document.getElementById('font-size');
    if (fontSizeSlider) {
        fontSizeSlider.addEventListener('input', function() {
            const fontSize = this.value;
            console.log('Setting font size to:', fontSize + '%');
            
            // Apply font size immediately
            document.documentElement.style.setProperty('--base-font-size', fontSize + '%');
            
            // Update slider display
            updateSliderValue('font-size');
            
            // Save to localStorage immediately
            const settings = JSON.parse(localStorage.getItem('appSettings') || '{}');
            settings.fontSize = parseInt(fontSize);
            localStorage.setItem('appSettings', JSON.stringify(settings));
        });
    }
}

// Initialize toggle functionality
function initializeToggles() {
    // Animations toggle
    const animationsToggle = document.getElementById('animations-toggle');
    if (animationsToggle) {
        animationsToggle.addEventListener('change', function() {
            document.body.classList.toggle('no-animations', !this.checked);
            const settings = JSON.parse(localStorage.getItem('appSettings') || '{}');
            settings.animations = this.checked;
            localStorage.setItem('appSettings', JSON.stringify(settings));
        });
    }
    
    // Reduce motion toggle
    const reduceMotionToggle = document.getElementById('reduce-motion');
    if (reduceMotionToggle) {
        reduceMotionToggle.addEventListener('change', function() {
            document.body.classList.toggle('reduce-motion', this.checked);
            const settings = JSON.parse(localStorage.getItem('appSettings') || '{}');
            settings.reduceMotion = this.checked;
            localStorage.setItem('appSettings', JSON.stringify(settings));
        });
    }
}

// Save settings
function saveSettings() {
    try {
        const settings = {
            theme: document.documentElement.getAttribute('data-theme'),
            accentColor: document.documentElement.style.getPropertyValue('--primary-color') || '#7c3aed',
            fontSize: parseInt(document.getElementById('font-size')?.value || 100),
            animations: document.getElementById('animations-toggle')?.checked !== false,
            reduceMotion: document.getElementById('reduce-motion')?.checked === true,
            questionCount: document.getElementById('question-count')?.value || '20',
            timeLimit: document.getElementById('time-limit')?.value || '30',
            showHints: document.getElementById('show-hints')?.checked !== false,
            instantFeedback: document.getElementById('instant-feedback')?.checked !== false,
            soundEffects: document.getElementById('sound-effects')?.checked !== false,
            volume: document.getElementById('volume')?.value || 70,
            studyReminders: document.getElementById('study-reminders')?.checked === true,
            achievementAlerts: document.getElementById('achievement-alerts')?.checked === true,
        };
        
        console.log('Saving settings:', settings);
        localStorage.setItem('appSettings', JSON.stringify(settings));
        showMessage('success', 'Settings saved successfully!');
    } catch (error) {
        console.error('Error saving settings:', error);
        showMessage('error', 'Failed to save settings');
    }
}

// Reset settings to defaults
function resetSettings() {
    if (confirm('Reset all settings to default values?')) {
        localStorage.removeItem('appSettings');
        location.reload();
    }
}

// Export user data
function exportUserData() {
    const userData = {
        settings: JSON.parse(localStorage.getItem('appSettings') || '{}'),
        stats: JSON.parse(localStorage.getItem('gameStats') || '{}'),
        history: JSON.parse(localStorage.getItem('quizHistory') || '[]'),
        achievements: JSON.parse(localStorage.getItem('achievements') || '[]')
    };
    
    const dataStr = JSON.stringify(userData, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(dataBlob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `linux-study-backup-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    
    showMessage('success', 'Data exported successfully!');
}

// Import user data
function importUserData() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    
    input.onchange = function(e) {
        const file = e.target.files[0];
        const reader = new FileReader();
        
        reader.onload = function(event) {
            try {
                const data = JSON.parse(event.target.result);
                
                // Validate data structure
                if (data.settings && data.stats) {
                    // Import data
                    localStorage.setItem('appSettings', JSON.stringify(data.settings));
                    localStorage.setItem('gameStats', JSON.stringify(data.stats));
                    localStorage.setItem('quizHistory', JSON.stringify(data.history || []));
                    localStorage.setItem('achievements', JSON.stringify(data.achievements || []));
                    
                    showMessage('success', 'Data imported successfully! Refreshing...');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showMessage('error', 'Invalid backup file format');
                }
            } catch (error) {
                showMessage('error', 'Failed to import data');
            }
        };
        
        reader.readAsText(file);
    };
    
    input.click();
}

// Confirm reset progress
function confirmResetProgress() {
    if (confirm('This will permanently delete all your quiz history and statistics. Are you sure?')) {
        if (confirm('This action cannot be undone. Please confirm again.')) {
            // Call the backend API to clear all statistics
            fetch('/api/clear_statistics', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Clear all localStorage items related to progress
                    const keysToRemove = [
                        'gameStats',
                        'quizHistory', 
                        'achievements',
                        'analyticsData',
                        'userProgress',
                        'dashboardStats',
                        'improvementMetrics',
                        'recentPerformance',
                        'sessionData',
                        'studyCalendar'
                    ];
                    
                    keysToRemove.forEach(key => {
                        localStorage.removeItem(key);
                    });
                    
                    // Clear any sessionStorage as well
                    sessionStorage.clear();
                    
                    // Clear browser cache for API endpoints
                    if ('caches' in window) {
                        caches.keys().then(function(names) {
                            names.forEach(function(name) {
                                caches.delete(name);
                            });
                        });
                    }
                    
                    showMessage('success', 'Progress reset successfully');
                    // Force a hard reload to ensure all cached data is cleared
                    setTimeout(() => window.location.reload(true), 1500);
                } else {
                    showMessage('error', 'Failed to reset progress: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error resetting progress:', error);
                showMessage('error', 'Failed to reset progress');
            });
        }
    }
}

// Clear cache
function clearCache() {
    if (confirm('Clear all cached data?')) {
        // Clear specific cached items
        const keysToKeep = ['appSettings', 'gameStats', 'quizHistory', 'achievements'];
        const allKeys = Object.keys(localStorage);
        
        allKeys.forEach(key => {
            if (!keysToKeep.includes(key)) {
                localStorage.removeItem(key);
            }
        });
        
        showMessage('success', 'Cache cleared successfully');
    }
}

// Confirm delete account
function confirmDeleteAccount() {
    const confirmation = prompt('Type "DELETE" to permanently delete your account and all data:');
    
    if (confirmation === 'DELETE') {
        localStorage.clear();
        showMessage('success', 'Account deleted. Redirecting...');
        setTimeout(() => {
            window.location.href = '/';
        }, 2000);
    }
}

// Game Values Functions
function loadGameValues() {
    fetch('/api/load_game_values')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.values) {
                populateGameValues(data.values);
            } else {
                console.error('Failed to load game values:', data.error);
            }
        })
        .catch(error => {
            console.error('Error loading game values:', error);
        });
}

function populateGameValues(values) {
    // Scoring settings
    if (values.scoring) {
        setIfExists('points-per-correct', values.scoring.points_per_correct);
        setIfExists('points-per-incorrect', values.scoring.points_per_incorrect);
        setIfExists('hint-penalty', values.scoring.hint_penalty);
        setIfExists('speed-bonus', values.scoring.speed_bonus);
        setIfExists('streak-bonus', values.scoring.streak_bonus);
        setIfExists('max-streak-bonus', values.scoring.max_streak_bonus);
        setIfExists('streak-bonus-threshold', values.scoring.streak_bonus_threshold);
        setIfExists('streak-bonus-multiplier', values.scoring.streak_bonus_multiplier);
        setIfExists('perfect-quiz-bonus', values.scoring.perfect_quiz_bonus);
        setIfExists('daily-challenge-bonus', values.scoring.daily_challenge_bonus);
        setIfExists('achievement-point-threshold', values.scoring.achievement_point_threshold);
        setIfExists('achievement-question-threshold', values.scoring.achievement_question_threshold);
        setIfExists('xp-multiplier', values.scoring.xp_multiplier);
    }
    
    // Streak settings
    if (values.streaks) {
        setIfExists('daily-streak-threshold', values.streaks.daily_streak_threshold);
        setIfExists('weekly-streak-threshold', values.streaks.weekly_streak_threshold);
    }
    
    // Accuracy settings
    if (values.accuracy) {
        setIfExists('excellent-threshold', values.accuracy.excellent_threshold);
        setIfExists('good-threshold', values.accuracy.good_threshold);
        setIfExists('passing-percentage', values.accuracy.passing_percentage);
    }
}

function setIfExists(id, value) {
    const element = document.getElementById(id);
    if (element) {
        element.value = value;
    }
}

function saveGameValues() {
    const gameValues = {
        scoring: {
            points_per_correct: parseInt(document.getElementById('points-per-correct')?.value) || 10,
            points_per_incorrect: parseInt(document.getElementById('points-per-incorrect')?.value) || 0,
            hint_penalty: parseInt(document.getElementById('hint-penalty')?.value) || 5,
            speed_bonus: parseInt(document.getElementById('speed-bonus')?.value) || 5,
            streak_bonus: parseInt(document.getElementById('streak-bonus')?.value) || 5,
            max_streak_bonus: parseInt(document.getElementById('max-streak-bonus')?.value) || 50,
            streak_bonus_threshold: parseInt(document.getElementById('streak-bonus-threshold')?.value) || 3,
            streak_bonus_multiplier: parseFloat(document.getElementById('streak-bonus-multiplier')?.value) || 2.0,
            perfect_quiz_bonus: parseInt(document.getElementById('perfect-quiz-bonus')?.value) || 25,
            daily_challenge_bonus: parseInt(document.getElementById('daily-challenge-bonus')?.value) || 50,
            achievement_point_threshold: parseInt(document.getElementById('achievement-point-threshold')?.value) || 500,
            achievement_question_threshold: parseInt(document.getElementById('achievement-question-threshold')?.value) || 100,
            xp_multiplier: parseFloat(document.getElementById('xp-multiplier')?.value) || 1.0
        },
        streaks: {
            daily_streak_threshold: parseInt(document.getElementById('daily-streak-threshold')?.value) || 3,
            weekly_streak_threshold: parseInt(document.getElementById('weekly-streak-threshold')?.value) || 7
        },
        accuracy: {
            excellent_threshold: parseInt(document.getElementById('excellent-threshold')?.value) || 90,
            good_threshold: parseInt(document.getElementById('good-threshold')?.value) || 75,
            passing_percentage: parseInt(document.getElementById('passing-percentage')?.value) || 70
        }
    };
    
    // Validation
    if (gameValues.scoring.max_streak_bonus < gameValues.scoring.streak_bonus) {
        showMessage('error', 'Max Streak Bonus cannot be less than Streak Bonus');
        return;
    }
    
    if (gameValues.accuracy.good_threshold >= gameValues.accuracy.excellent_threshold) {
        showMessage('error', 'Good threshold must be less than excellent threshold');
        return;
    }
    
    fetch('/api/save_game_values', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(gameValues)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('success', 'Game values saved successfully!');
        } else {
            showMessage('error', 'Failed to save game values: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error saving game values:', error);
        showMessage('error', 'An error occurred while saving game values');
    });
}

function resetGameValuesToDefaults() {
    if (confirm('Reset all game values to defaults? This cannot be undone.')) {
        fetch('/api/reset_game_values', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMessage('success', 'Game values reset to defaults!');
                loadGameValues(); // Reload the form
            } else {
                showMessage('error', 'Failed to reset game values: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error resetting game values:', error);
            showMessage('error', 'An error occurred while resetting game values');
        });
    }
}

function showMessage(type, text) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type} animate-fade-in`;
    messageDiv.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
        ${text}
    `;
    
    const container = document.querySelector('.container');
    container.insertBefore(messageDiv, container.firstChild);
    
    setTimeout(() => {
        messageDiv.remove();
    }, 3000);
}

// Profile Management Functions
let currentProfileId = null;

function loadProfiles() {
    // Show loading state
    const profilesList = document.getElementById('profiles-list');
    if (profilesList) {
        profilesList.innerHTML = '<div class="profile-loading">Loading profiles...</div>';
    }
    
    fetch('/api/profiles')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayProfiles(data.profiles, data.current_profile);
            } else {
                showMessage('error', 'Failed to load profiles: ' + (data.error || 'Unknown error'));
                if (profilesList) {
                    profilesList.innerHTML = '<div class="profile-empty">Failed to load profiles. Click "Refresh Profiles" to try again.</div>';
                }
            }
        })
        .catch(error => {
            console.error('Error loading profiles:', error);
            showMessage('error', 'An error occurred while loading profiles');
            if (profilesList) {
                profilesList.innerHTML = '<div class="profile-empty">Error loading profiles. Click "Refresh Profiles" to try again.</div>';
            }
        });
}

function displayProfiles(profiles, currentProfile) {
    currentProfileId = currentProfile;
    
    // Update current profile display
    const currentProfileName = document.getElementById('current-profile-name');
    const currentProfileStats = document.getElementById('current-profile-stats');
    
    if (profiles[currentProfile]) {
        currentProfileName.textContent = profiles[currentProfile].name;
        const sessionCount = profiles[currentProfile].analytics?.sessions?.length || 0;
        currentProfileStats.textContent = `(${sessionCount} sessions)`;
    }
    
    // Update profiles list
    const profilesList = document.getElementById('profiles-list');
    profilesList.innerHTML = '';
    
    if (Object.keys(profiles).length === 0) {
        profilesList.innerHTML = '<div class="profile-empty">No profiles found</div>';
        return;
    }
    
    Object.entries(profiles).forEach(([id, profile]) => {
        const profileItem = document.createElement('div');
        profileItem.className = `profile-item ${id === currentProfile ? 'active' : ''}`;
        
        const sessionCount = profile.analytics?.sessions?.length || 0;
        const lastStudy = profile.analytics?.sessions?.length > 0 
            ? new Date(profile.analytics.sessions[profile.analytics.sessions.length - 1].timestamp).toLocaleDateString()
            : 'Never';
        
        profileItem.innerHTML = `
            <div class="profile-info">
                <h5>${profile.name}</h5>
                <p>${sessionCount} sessions • Last study: ${lastStudy}</p>
            </div>
            <div class="profile-actions">
                ${id !== currentProfile ? `<button class="btn btn-sm btn-primary" onclick="switchProfile('${id}')">
                    <i class="fas fa-user-check"></i> Switch
                </button>` : '<span class="badge badge-success">Active</span>'}
                <button class="btn btn-sm btn-warning" onclick="renameProfile('${id}', '${profile.name}')">
                    <i class="fas fa-edit"></i> Rename
                </button>
                <button class="btn btn-sm btn-info" onclick="resetProfile('${id}')" title="Clear all progress for this profile only">
                    <i class="fas fa-undo"></i> Reset Progress
                </button>
                ${Object.keys(profiles).length > 1 ? `<button class="btn btn-sm btn-danger" onclick="deleteProfile('${id}', '${profile.name}')" title="Permanently remove this profile and all its data">
                    <i class="fas fa-trash"></i> Delete Profile
                </button>` : ''}
            </div>
        `;
        
        profilesList.appendChild(profileItem);
    });
}

function createNewProfile() {
    const nameInput = document.getElementById('new-profile-name');
    const name = nameInput.value.trim();
    
    if (!name) {
        showMessage('error', 'Please enter a profile name');
        return;
    }
    
    if (name.length > 30) {
        showMessage('error', 'Profile name must be 30 characters or less');
        return;
    }
    
    fetch('/api/profiles', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ name: name })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('success', `Profile "${name}" created successfully!`);
            nameInput.value = '';
            loadProfiles();
        } else {
            showMessage('error', 'Failed to create profile: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error creating profile:', error);
        showMessage('error', 'An error occurred while creating the profile');
    });
}

function switchProfile(profileId) {
    if (profileId === currentProfileId) {
        showMessage('info', 'This profile is already active');
        return;
    }
    
    fetch('/api/profiles/switch', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ profile_id: profileId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('success', 'Profile switched successfully!');
            loadProfiles();
            // Refresh the page to update all data
            setTimeout(() => location.reload(), 1000);
        } else {
            showMessage('error', 'Failed to switch profile: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error switching profile:', error);
        showMessage('error', 'An error occurred while switching profiles');
    });
}

function renameProfile(profileId, currentName) {
    const newName = prompt(`Enter new name for profile "${currentName}":`, currentName);
    
    if (newName === null) return; // User cancelled
    
    const trimmedName = newName.trim();
    if (!trimmedName) {
        showMessage('error', 'Profile name cannot be empty');
        return;
    }
    
    if (trimmedName.length > 30) {
        showMessage('error', 'Profile name must be 30 characters or less');
        return;
    }
    
    if (trimmedName === currentName) {
        showMessage('info', 'No changes made');
        return;
    }
    
    fetch(`/api/profiles/${profileId}/rename`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ name: trimmedName })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('success', `Profile renamed to "${trimmedName}" successfully!`);
            loadProfiles();
        } else {
            showMessage('error', 'Failed to rename profile: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error renaming profile:', error);
        showMessage('error', 'An error occurred while renaming the profile');
    });
}

function resetProfile(profileId) {
    const confirmReset = confirm('Are you sure you want to reset this profile? This will clear all progress and statistics. This action cannot be undone.');
    
    if (!confirmReset) return;
    
    fetch(`/api/profiles/${profileId}/reset`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('success', 'Profile reset successfully!');
            loadProfiles();
            // If this is the current profile, refresh the page
            if (profileId === currentProfileId) {
                setTimeout(() => location.reload(), 1000);
            }
        } else {
            showMessage('error', 'Failed to reset profile: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error resetting profile:', error);
        showMessage('error', 'An error occurred while resetting the profile');
    });
}

function deleteProfile(profileId, profileName) {
    const confirmDelete = confirm(`Are you sure you want to delete the profile "${profileName}"? This action cannot be undone.`);
    
    if (!confirmDelete) return;
    
    if (profileId === currentProfileId) {
        showMessage('error', 'Cannot delete the currently active profile. Switch to another profile first.');
        return;
    }
    
    fetch(`/api/profiles/${profileId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('success', `Profile "${profileName}" deleted successfully!`);
            loadProfiles();
        } else {
            showMessage('error', 'Failed to delete profile: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error deleting profile:', error);
        showMessage('error', 'An error occurred while deleting the profile');
    });
}

function exportProfiles() {
    fetch('/api/profiles')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const dataStr = JSON.stringify(data.profiles, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `linux_plus_profiles_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showMessage('success', 'Profiles exported successfully!');
            } else {
                showMessage('error', 'Failed to export profiles: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error exporting profiles:', error);
            showMessage('error', 'An error occurred while exporting profiles');
        });
}

// Load profiles when the profiles panel is shown
// Add event listener for new profile form
document.addEventListener('DOMContentLoaded', function() {
    const newProfileInput = document.getElementById('new-profile-name');
    if (newProfileInput) {
        newProfileInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                createNewProfile();
            }
        });
    }
});

// System Settings Functions
function loadSystemSettings() {
    fetch('/api/get_system_settings')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const settings = data.settings;
                const focusModeToggle = document.getElementById('focus-mode-toggle');
                const breakReminderToggle = document.getElementById('break-reminder-toggle');
                const breakReminderInterval = document.getElementById('break-reminder-interval');
                
                if (focusModeToggle) {
                    focusModeToggle.checked = settings.focus_mode_enabled || false;
                }
                if (breakReminderToggle) {
                    breakReminderToggle.checked = settings.break_reminder_enabled !== false;
                }
                if (breakReminderInterval) {
                    breakReminderInterval.value = settings.break_reminder_interval || 15;
                }
            }
        })
        .catch(error => {
            console.error('Error loading system settings:', error);
        });
}

function saveSystemSettings() {
    const focusModeToggle = document.getElementById('focus-mode-toggle');
    const breakReminderToggle = document.getElementById('break-reminder-toggle');
    const breakReminderInterval = document.getElementById('break-reminder-interval');
    
    const systemSettings = {
        focus_mode_enabled: focusModeToggle ? focusModeToggle.checked : false,
        break_reminder_enabled: breakReminderToggle ? breakReminderToggle.checked : true,
        break_reminder_interval: breakReminderInterval ? parseInt(breakReminderInterval.value) || 15 : 15
    };
    
    fetch('/api/save_system_settings', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(systemSettings)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('success', 'System settings saved successfully!');
        } else {
            showMessage('error', 'Failed to save system settings: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error saving system settings:', error);
        showMessage('error', 'An error occurred while saving system settings');
    });
}

// Achievement Management Functions
function createCustomAchievement() {
    const nameInput = document.getElementById('achievement-name');
    const descriptionInput = document.getElementById('achievement-description');
    const conditionTypeInput = document.getElementById('achievement-condition-type');
    const conditionValueInput = document.getElementById('achievement-condition-value');
    const xpRewardInput = document.getElementById('achievement-xp-reward');
    
    const achievementData = {
        name: nameInput.value.trim(),
        description: descriptionInput.value.trim(),
        condition_type: conditionTypeInput.value,
        condition_value: parseInt(conditionValueInput.value) || 0,
        xp_reward: parseInt(xpRewardInput.value) || 0
    };
    
    // Validation
    if (!achievementData.name || !achievementData.description) {
        showMessage('error', 'Name and description are required');
        return;
    }
    
    if (achievementData.condition_value <= 0) {
        showMessage('error', 'Condition value must be greater than 0');
        return;
    }
    
    if (achievementData.xp_reward <= 0) {
        showMessage('error', 'XP reward must be greater than 0');
        return;
    }
    
    fetch('/api/create_achievement', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(achievementData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('success', 'Achievement created successfully!');
            
            // Clear form
            nameInput.value = '';
            descriptionInput.value = '';
            conditionValueInput.value = '100';
            xpRewardInput.value = '100';
            
            // Reload achievements list
            loadCustomAchievements();
        } else {
            showMessage('error', 'Failed to create achievement: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error creating achievement:', error);
        showMessage('error', 'An error occurred while creating achievement');
    });
}

function loadCustomAchievements() {
    const achievementsList = document.getElementById('custom-achievements-list');
    if (!achievementsList) return;
    
    achievementsList.innerHTML = '<div class="achievement-loading">Loading achievements...</div>';
    
    fetch('/api/get_custom_achievements')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayCustomAchievements(data.achievements);
            } else {
                achievementsList.innerHTML = '<div class="achievement-empty">Failed to load achievements</div>';
            }
        })
        .catch(error => {
            console.error('Error loading custom achievements:', error);
            achievementsList.innerHTML = '<div class="achievement-empty">Error loading achievements</div>';
        });
}

function displayCustomAchievements(achievements) {
    const achievementsList = document.getElementById('custom-achievements-list');
    if (!achievementsList) return;
    
    if (achievements.length === 0) {
        achievementsList.innerHTML = '<div class="achievement-empty">No custom achievements created yet</div>';
        return;
    }
    
    achievementsList.innerHTML = achievements.map(achievement => `
        <div class="achievement-item">
            <div class="achievement-info">
                <h5>${achievement.name}</h5>
                <p>${achievement.description}</p>
                <div class="achievement-meta">
                    <span>Condition: ${achievement.condition_value} ${achievement.condition_type}</span>
                    <span>Reward: ${achievement.xp_reward} XP</span>
                    <span class="achievement-status ${achievement.unlocked ? 'unlocked' : 'locked'}">
                        ${achievement.unlocked ? 'Unlocked' : 'Locked'}
                    </span>
                </div>
            </div>
            <div class="achievement-actions">
                <button class="btn btn-sm btn-danger" onclick="deleteCustomAchievement('${achievement.name}')">
                    <i class="fas fa-trash"></i> Delete
                </button>
            </div>
        </div>
    `).join('');
}

function deleteCustomAchievement(name) {
    if (!confirm(`Are you sure you want to delete the achievement "${name}"?`)) {
        return;
    }
    
    fetch('/api/delete_achievement', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ name: name })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('success', 'Achievement deleted successfully!');
            loadCustomAchievements();
        } else {
            showMessage('error', 'Failed to delete achievement: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error deleting achievement:', error);
        showMessage('error', 'An error occurred while deleting achievement');
    });
}

// Enhanced saveSettings function to include system settings
function saveAllSettings() {
    // Save regular settings
    saveSettings();
    
    // Save game values
    saveGameValues();
    
    // Save system settings
    saveSystemSettings();
}

</script>
{% endblock %}
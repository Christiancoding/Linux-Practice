{% extends "base.html" %}

{% block title %}Practice Quiz - Linux+ Study Game{% endblock %}

{% block content %}
<!-- Quiz Page -->
<div class="page-content active" id="page-quiz">
    <!-- Quiz Setup (shown before quiz starts) -->
    <div id="quiz-setup" class="quiz-setup-container">
        <div class="page-header" data-aos="fade-down">
            <h1 class="page-title">
                <i class="fas fa-brain text-gradient"></i>
                Practice Quiz
            </h1>
            <p class="page-subtitle">Test your Linux knowledge and improve your skills</p>
        </div>

        <!-- Quiz Mode Selection -->
        <section class="quiz-modes glass" data-aos="fade-up">
            <h2 class="section-header">
                <i class="fas fa-gamepad"></i> Choose Your Mode
            </h2>
            <div class="mode-cards">
                <div class="mode-card" onclick="selectMode('standard')" data-aos="fade-up" data-aos-delay="100">
                    <div class="mode-icon" style="background: var(--gradient-primary);">
                        <i class="fas fa-graduation-cap"></i>
                    </div>
                    <h3>Standard Mode</h3>
                    <p>Learn at your own pace with instant feedback</p>
                    <ul class="mode-features">
                        <li><i class="fas fa-check"></i> Unlimited time</li>
                        <li><i class="fas fa-check"></i> Instant feedback</li>
                        <li><i class="fas fa-check"></i> Explanations</li>
                    </ul>
                </div>

                <div class="mode-card" onclick="selectMode('timed')" data-aos="fade-up" data-aos-delay="200">
                    <div class="mode-icon" style="background: var(--gradient-warning);">
                        <i class="fas fa-stopwatch"></i>
                    </div>
                    <h3>Timed Challenge</h3>
                    <p>Race against the clock for bonus points</p>
                    <ul class="mode-features">
                        <li><i class="fas fa-clock"></i> 30s per question</li>
                        <li><i class="fas fa-fire"></i> Speed bonus</li>
                        <li><i class="fas fa-trophy"></i> Leaderboard</li>
                    </ul>
                </div>

                <div class="mode-card" onclick="selectMode('survival')" data-aos="fade-up" data-aos-delay="250">
                    <div class="mode-icon" style="background: var(--gradient-success);">
                        <i class="fas fa-heart"></i>
                    </div>
                    <h3>Survival Mode</h3>
                    <p>Keep your streak alive - 3 strikes and you're out!</p>
                    <ul class="mode-features">
                        <li><i class="fas fa-heart"></i> 3 lives only</li>
                        <li><i class="fas fa-infinity"></i> Endless questions</li>
                        <li><i class="fas fa-medal"></i> High score tracking</li>
                    </ul>
                </div>

                <div class="mode-card" onclick="selectMode('exam')" data-aos="fade-up" data-aos-delay="300">
                    <div class="mode-icon" style="background: var(--gradient-danger);">
                        <i class="fas fa-clipboard-check"></i>
                    </div>
                    <h3>Exam Simulation</h3>
                    <p>Practice like the real Linux+ exam</p>
                    <ul class="mode-features">
                        <li><i class="fas fa-list-ol"></i> 90 questions</li>
                        <li><i class="fas fa-hourglass"></i> 90 minutes</li>
                        <li><i class="fas fa-chart-bar"></i> Final score only</li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- Quiz Options -->
        <section class="quiz-options glass" data-aos="fade-up" data-aos-delay="400">
            <h2 class="section-header">
                <i class="fas fa-sliders-h"></i> Customize Your Quiz
            </h2>
            <div class="options-grid">
                <div class="option-group" id="num-questions-group">
                    <label>Number of Questions</label>
                    <select id="num-questions">
                        <option value="">Loading...</option>
                    </select>
                    <small class="text-muted" id="questions-help">Loading question count...</small>
                </div>
                <div class="option-group">
                    <label>Category</label>
                    <select id="quiz-category">
                        <option value="All Categories">All Categories</option>
                        <option value="">Loading...</option>
                    </select>
                </div>
                <div class="option-group">
                    <label>Difficulty</label>
                    <select id="quiz-difficulty">
                        <option value="all">All Levels</option>
                        <option value="">Loading...</option>
                    </select>
                </div>
            </div>
            <button class="btn btn-primary btn-lg mt-4" onclick="startQuiz()">
                <i class="fas fa-play"></i> Start Quiz
            </button>
        </section>
    </div>

    <!-- Quiz Container (shown during quiz) -->
    <div id="quiz-container" class="quiz-container" style="display: none;">
        <!-- Quiz Header -->
        <div class="quiz-header glass">
            <div class="quiz-info">
                <div class="quiz-progress">
                    <span class="progress-label">Question</span>
                    <span class="progress-numbers">
                        <span id="current-question">1</span> / <span id="total-questions">20</span>
                    </span>
                </div>
                <div class="quiz-timer" id="quiz-timer" style="display: none;">
                    <i class="fas fa-clock"></i>
                    <span id="time-remaining">30</span>s
                </div>
                
                <!-- Survival Lives Display -->
                <div class="survival-lives" id="survival-lives" style="display: none;">
                    <i class="fas fa-heart"></i>
                    <span id="lives-count">3</span> lives
                </div>
            </div>
            <div class="quiz-actions">
                <button class="btn btn-sm btn-secondary" onclick="pauseQuiz()">
                    <i class="fas fa-pause"></i> Pause
                </button>
                <button class="btn btn-sm btn-danger" onclick="endQuiz()">
                    <i class="fas fa-stop"></i> End Quiz
                </button>
            </div>
        </div>

        <!-- Progress Bar -->
        <div class="quiz-progress-bar">
            <div class="progress-track">
                <div class="progress-fill" id="progress-fill" style="width: 0%;">
                    <div class="progress-glow"></div>
                </div>
            </div>
            <div class="progress-dots" id="progress-dots">
                <!-- Dots will be generated dynamically -->
            </div>
        </div>

        <!-- Question Container -->
        <div class="question-container glass" id="question-container">
            <div class="question-header">
                <span class="question-category" id="question-category">
                    <i class="fas fa-tag"></i> System Administration
                </span>
                <span class="question-points">
                    <i class="fas fa-star"></i> <span id="question-points">0</span> points
                </span>
            </div>

            <div class="question-content">
                <h2 class="question-text" id="question-text">
                    Which command is used to display the current directory path in Linux?
                </h2>

                <div class="answer-options" id="answer-options">
                    <div class="answer-option" onclick="selectAnswer(0)">
                        <span class="option-letter">A</span>
                        <span class="option-text">pwd</span>
                        <span class="option-indicator"></span>
                    </div>
                    <div class="answer-option" onclick="selectAnswer(1)">
                        <span class="option-letter">B</span>
                        <span class="option-text">cd</span>
                        <span class="option-indicator"></span>
                    </div>
                    <div class="answer-option" onclick="selectAnswer(2)">
                        <span class="option-letter">C</span>
                        <span class="option-text">ls</span>
                        <span class="option-indicator"></span>
                    </div>
                    <div class="answer-option" onclick="selectAnswer(3)">
                        <span class="option-letter">D</span>
                        <span class="option-text">dir</span>
                        <span class="option-indicator"></span>
                    </div>
                </div>
            </div>

            <!-- Explanation (shown after answer) -->
            <div class="explanation-box" id="explanation-box" style="display: none;">
                <h4><i class="fas fa-lightbulb"></i> Explanation</h4>
                <p id="explanation-text">The 'pwd' command stands for "print working directory" and displays the full path of the current directory.</p>
            </div>

            <!-- Action Buttons -->
            <div class="question-actions">
                <button class="btn btn-secondary" onclick="useHint()" id="hint-btn">
                    <i class="fas fa-lightbulb"></i> Use Hint (-<span id="hint-penalty">{{ game_values.scoring.hint_penalty if game_values else 5 }}</span> points)
                </button>
                <button class="btn btn-primary" onclick="nextQuestion()" id="next-btn" style="display: none;">
                    Next Question <i class="fas fa-arrow-right"></i>
                </button>
                <button class="btn btn-primary" onclick="submitAnswer()" id="submit-btn">
                    Submit Answer
                </button>
            </div>
        </div>

        <!-- Streak Indicator -->
        <div class="streak-indicator" id="streak-indicator" style="display: none;">
            <i class="fas fa-fire"></i>
            <span id="streak-count">0</span> Streak!
        </div>
    </div>

    <!-- Quiz Results (shown after quiz) -->
    <div id="quiz-results" class="quiz-results" style="display: none;">
        <div class="results-container glass" data-aos="zoom-in">
            <h1 class="results-title text-gradient">Quiz Complete!</h1>
            
            <div class="score-circle">
                <svg width="200" height="200">
                    <circle cx="100" cy="100" r="90" stroke="var(--bg-tertiary)" stroke-width="10" fill="none"/>
                    <circle class="score-ring" cx="100" cy="100" r="90" stroke="url(#scoreGradient)" 
                            stroke-width="10" fill="none" stroke-dasharray="565.48" 
                            stroke-dashoffset="565.48" stroke-linecap="round" transform="rotate(-90 100 100)"/>
                    <defs>
                        <linearGradient id="scoreGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#10b981;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#84cc16;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                </svg>
                <div class="score-text">
                    <span class="score-percent" id="score-percent">0%</span>
                    <span class="score-label">Score</span>
                </div>
            </div>

            <div class="results-stats">
                <div class="result-stat">
                    <i class="fas fa-check-circle" style="color: var(--success-color);"></i>
                    <div>
                        <h3 id="correct-count">0</h3>
                        <p>Correct</p>
                    </div>
                </div>
                <div class="result-stat">
                    <i class="fas fa-times-circle" style="color: var(--danger-color);"></i>
                    <div>
                        <h3 id="incorrect-count">0</h3>
                        <p>Incorrect</p>
                    </div>
                </div>
                <div class="result-stat">
                    <i class="fas fa-clock" style="color: var(--warning-color);"></i>
                    <div>
                        <h3 id="time-taken">0:00</h3>
                        <p>Time</p>
                    </div>
                </div>
                <div class="result-stat">
                    <i class="fas fa-star" style="color: var(--primary-color);"></i>
                    <div>
                        <h3 id="points-earned">0</h3>
                        <p>Points</p>
                    </div>
                </div>
            </div>

            <div class="results-breakdown">
                <h3>Category Performance</h3>
                <div class="category-bars" id="category-performance">
                    <!-- Generated dynamically -->
                </div>
            </div>

            <div class="results-actions">
                <button class="btn btn-secondary" onclick="reviewAnswers()">
                    <i class="fas fa-eye"></i> Review Answers
                </button>
                <button class="btn btn-primary" onclick="startNewQuiz()">
                    <i class="fas fa-redo"></i> New Quiz
                </button>
                <button class="btn btn-success" onclick="shareResults()">
                    <i class="fas fa-share"></i> Share
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Pause Modal -->
<div id="pause-modal" class="modal">
    <div class="modal-content glass">
        <h2><i class="fas fa-pause-circle"></i> Quiz Paused</h2>
        <p>Take a break! Your progress is saved.</p>
        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="resumeQuiz()">
                <i class="fas fa-play"></i> Resume
            </button>
            <button class="btn btn-danger" onclick="confirmEndQuiz()">
                <i class="fas fa-stop"></i> End Quiz
            </button>
        </div>
    </div>
</div>

<style>
/* Quiz Page Specific Styles */
.quiz-setup-container {
    max-width: 1200px;
    margin: 0 auto;
}

/* Mode Selection */
.quiz-modes {
    padding: 2rem;
    margin-bottom: 2rem;
}

.mode-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
}

.mode-card {
    padding: 2rem;
    background: var(--bg-tertiary);
    border: 2px solid var(--border-color);
    border-radius: var(--radius-lg);
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
}

.mode-card:hover {
    transform: translateY(-4px);
    border-color: var(--primary-color);
    box-shadow: var(--shadow-xl);
}

.mode-card.selected {
    border-color: var(--primary-color);
    background: linear-gradient(135deg, rgba(124, 58, 237, 0.1) 0%, rgba(236, 72, 153, 0.1) 100%);
}

.mode-icon {
    width: 80px;
    height: 80px;
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 1.5rem;
    font-size: 2rem;
    color: white;
}

.mode-card h3 {
    margin-bottom: 0.5rem;
    font-size: 1.5rem;
}

.mode-card p {
    color: var(--text-secondary);
    margin-bottom: 1.5rem;
}

.mode-features {
    list-style: none;
    padding: 0;
    margin: 0;
    text-align: left;
    display: inline-block;
}

.mode-features li {
    padding: 0.5rem 0;
    color: var(--text-secondary);
}

.mode-features i {
    color: var(--success-color);
    margin-right: 0.5rem;
}

/* Quiz Options */
.quiz-options {
    padding: 2rem;
    text-align: center;
}

.options-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    max-width: 800px;
    margin: 0 auto;
}

.option-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: var(--text-primary);
}

/* Quiz Container */
.quiz-container {
    max-width: 900px;
    margin: 0 auto;
}

.quiz-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.quiz-info {
    display: flex;
    align-items: center;
    gap: 2rem;
}

.quiz-progress {
    display: flex;
    flex-direction: column;
}

.progress-label {
    font-size: 0.875rem;
    color: var(--text-secondary);
}

.progress-numbers {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--text-primary);
}

.quiz-timer {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.25rem;
    background: var(--bg-tertiary);
    border-radius: var(--radius-full);
    font-weight: 600;
}

.quiz-timer.warning {
    background: var(--gradient-warning);
    color: white;
    animation: pulse 1s ease-in-out infinite;
}

.quiz-timer.danger {
    background: var(--gradient-danger);
    color: white;
    animation: pulse 0.5s ease-in-out infinite;
}

/* Survival Lives Display */
.survival-lives {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.25rem;
    background: var(--gradient-danger);
    color: white;
    border-radius: var(--radius-full);
    font-weight: 600;
}

.survival-lives i {
    color: #ff6b6b;
    animation: heartbeat 1.5s ease-in-out infinite;
}

@keyframes heartbeat {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

/* Progress Bar */
.quiz-progress-bar {
    position: relative;
    margin-bottom: 2rem;
}

.progress-track {
    height: 8px;
    background: var(--bg-tertiary);
    border-radius: var(--radius-full);
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: var(--gradient-primary);
    transition: width 1.2s ease-out;
    position: relative;
}

.progress-glow {
    position: absolute;
    top: 0;
    right: 0;
    width: 30px;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3));
    opacity: 0.7;
}

.progress-dots {
    display: flex;
    justify-content: space-between;
    margin-top: 0.5rem;
    position: relative;
}

.progress-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: var(--bg-tertiary);
    transition: all 0.3s ease;
    position: relative;
    z-index: 2;
}

.progress-dot.completed {
    background: var(--success-color);
}

.progress-dot.current {
    background: var(--primary-color);
    transform: scale(1.2);
}

/* Question Container */
.question-container {
    padding: 2.5rem;
    animation: fadeInUp 0.6s ease;
}

.question-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
}

.question-category {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: var(--bg-tertiary);
    border-radius: var(--radius-full);
    font-size: 0.875rem;
    color: var(--text-secondary);
}

.question-points {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--warning-color);
    font-weight: 600;
}

.question-text {
    font-size: 1.5rem;
    line-height: 1.6;
    margin-bottom: 2rem;
    color: var(--text-primary);
}

/* Answer Options */
.answer-options {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    margin-bottom: 2rem;
}

.answer-option {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1.25rem;
    background: var(--bg-tertiary);
    border: 2px solid var(--border-color);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.answer-option:hover {
    background: var(--bg-secondary);
    border-color: var(--primary-color);
    transform: translateX(4px);
}

.answer-option.selected {
    background: linear-gradient(135deg, rgba(124, 58, 237, 0.1) 0%, rgba(236, 72, 153, 0.1) 100%);
    border-color: var(--primary-color);
}

.answer-option.correct {
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(132, 204, 22, 0.1) 100%);
    border-color: var(--success-color);
}

.answer-option.incorrect {
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(220, 38, 38, 0.1) 100%);
    border-color: var(--danger-color);
}

.answer-option.disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.answer-option.eliminated {
    opacity: 0.3;
    cursor: not-allowed;
    background: linear-gradient(135deg, rgba(107, 114, 128, 0.1) 0%, rgba(75, 85, 99, 0.1) 100%);
    border-color: var(--text-tertiary);
    position: relative;
}

.answer-option.eliminated::after {
    content: '✕';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 2rem;
    color: var(--danger-color);
    font-weight: bold;
    z-index: 1;
}

.answer-option.eliminated .option-text {
    text-decoration: line-through;
    color: var(--text-tertiary);
}

.option-letter {
    width: 40px;
    height: 40px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    flex-shrink: 0;
}

.option-text {
    flex: 1;
    font-size: 1.125rem;
}

.option-indicator {
    position: absolute;
    right: 1.25rem;
    font-size: 1.25rem;
}

.answer-option.correct .option-indicator::after {
    content: '✓';
    color: var(--success-color);
}

.answer-option.incorrect .option-indicator::after {
    content: '✗';
    color: var(--danger-color);
}

/* Explanation Box */
.explanation-box {
    background: var(--bg-tertiary);
    border-left: 4px solid var(--accent-color);
    border-radius: var(--radius-md);
    padding: 1.5rem;
    margin-bottom: 2rem;
    animation: fadeIn 0.5s ease;
}

.explanation-box h4 {
    color: var(--accent-color);
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

/* Question Actions */
.question-actions {
    display: flex;
    justify-content: space-between;
    gap: 1rem;
}

/* Streak Indicator */
.streak-indicator {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: var(--gradient-danger);
    color: white;
    padding: 1rem 2rem;
    border-radius: var(--radius-full);
    font-size: 1.5rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    animation: bounceIn 0.5s ease;
    z-index: 1000;
}

@keyframes bounceIn {
    0% { transform: translate(-50%, -50%) scale(0); }
    50% { transform: translate(-50%, -50%) scale(1.2); }
    100% { transform: translate(-50%, -50%) scale(1); }
}

/* Results */
.quiz-results {
    max-width: 800px;
    margin: 0 auto;
    padding: 2rem 0;
}

.results-container {
    padding: 3rem;
    text-align: center;
}

.results-title {
    font-size: 2.5rem;
    margin-bottom: 2rem;
}

.score-circle {
    position: relative;
    width: 200px;
    height: 200px;
    margin: 0 auto 3rem;
}

.score-ring {
    transition: stroke-dashoffset 1s ease;
}

.score-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
}

.score-percent {
    display: block;
    font-size: 3rem;
    font-weight: 800;
    color: var(--text-primary);
}

.score-label {
    font-size: 1rem;
    color: var(--text-secondary);
}

.results-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 2rem;
    margin-bottom: 3rem;
}

.result-stat {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
}

.result-stat i {
    font-size: 2rem;
}

.result-stat h3 {
    font-size: 1.5rem;
    margin: 0;
}

.result-stat p {
    margin: 0;
    color: var(--text-secondary);
}

/* Category Performance */
.results-breakdown {
    margin-bottom: 2rem;
}

.results-breakdown h3 {
    margin-bottom: 1.5rem;
}

.category-bars {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    text-align: left;
}

.category-bar {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.category-name {
    min-width: 150px;
    font-weight: 600;
}

.bar-container {
    flex: 1;
    height: 20px;
    background: var(--bg-tertiary);
    border-radius: var(--radius-full);
    overflow: hidden;
}

.bar-fill {
    height: 100%;
    background: var(--gradient-success);
    transition: width 1s ease;
}

.category-score {
    min-width: 50px;
    text-align: right;
    font-weight: 600;
}

.results-actions {
    display: flex;
    gap: 1rem;
    justify-content: center;
    flex-wrap: wrap;
}

/* Responsive */
@media (max-width: 768px) {
    .mode-cards {
        grid-template-columns: 1fr;
    }
    
    .quiz-header {
        flex-direction: column;
        gap: 1rem;
    }
    
    .quiz-info {
        width: 100%;
        justify-content: space-between;
    }
    
    .question-text {
        font-size: 1.25rem;
    }
    
    .answer-option {
        padding: 1rem;
    }
    
    .option-text {
        font-size: 1rem;
    }
    
    .question-actions {
        flex-direction: column;
    }
    
    .question-actions button {
        width: 100%;
    }
}
</style>
{% endblock %}

{% block scripts %}
<script>
// Quiz state object to track quiz data
const quizState = {
    mode: null,
    totalQuestions: 0,
    currentQuestion: 0,
    answers: [],
    startTime: null,
    score: 0,
    streak: 0,
    survivalLives: 3,
    timePerQuestion: 30,
    timeLimit: 30,
    selectedAnswer: undefined,
    timer: null,
    questionStartTime: null
};

// Function to fetch and update session status from server
async function updateSessionStatus() {
    try {
        const response = await fetch('/api/status');
        if (response.ok) {
            const data = await response.json();
            
            // Update the question points display with session points
            const questionPointsElement = document.getElementById('question-points');
            if (questionPointsElement && data.session_points !== undefined) {
                questionPointsElement.textContent = data.session_points;
            }
            
            // Also update the local quiz state for consistency
            if (data.session_points !== undefined) {
                quizState.score = data.session_points;
            }
            
            return data;
        }
    } catch (error) {
        console.error('Error fetching session status:', error);
    }
    return null;
}

// Initialize quiz page
document.addEventListener('DOMContentLoaded', function() {
    console.log('✅ Quiz page loading...');
    console.log('✅ DOM Content Loaded');
    
    try {
        // Load all dynamic data
        loadQuizOptions();
        
        // Auto-select standard mode by default
        selectMode('standard');
        
        console.log('✅ Quiz page initialization complete');
    } catch (error) {
        console.error('❌ Error during quiz page initialization:', error);
        showMessage('error', `Quiz initialization failed: ${error.message}`);
    }
});

// Load all quiz options dynamically
function loadQuizOptions() {
    // Set loading state
    const startButton = document.querySelector('button[onclick="startQuiz()"]');
    if (startButton) {
        startButton.disabled = true;
        startButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading Options...';
    }
    
    // Load question count options
    updateQuestionCountOptions()
        .then(() => {
            // Load categories and difficulties in parallel
            return Promise.all([loadCategories(), loadDifficultyLevels()]);
        })
        .then(() => {
            // Re-enable start button once everything is loaded
            if (startButton) {
                startButton.disabled = false;
                startButton.innerHTML = '<i class="fas fa-play"></i> Start Quiz';
            }
            console.log('All quiz options loaded successfully');
        })
        .catch(error => {
            console.error('Error loading quiz options:', error);
            // Still re-enable the button so users can try with fallback values
            if (startButton) {
                startButton.disabled = false;
                startButton.innerHTML = '<i class="fas fa-play"></i> Start Quiz';
            }
        });
}

// Update question count options based on available questions
function updateQuestionCountOptions() {
    return fetch('/api/get_question_count')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const totalQuestions = data.total_questions;
                const select = document.getElementById('num-questions');
                
                // Clear existing options
                select.innerHTML = '';
                
                // Add appropriate options based on available questions
                const baseOptions = [5, 10, 15, 20, 25];
                const validOptions = baseOptions.filter(opt => opt <= totalQuestions);
                
                // Always include the total available
                if (!validOptions.includes(totalQuestions)) {
                    validOptions.push(totalQuestions);
                }
                
                // Sort options
                validOptions.sort((a, b) => a - b);
                
                validOptions.forEach(count => {
                    const option = document.createElement('option');
                    option.value = count;
                    if (count === totalQuestions) {
                        option.textContent = `All Available (${count})`;
                    } else {
                        option.textContent = `${count} Questions`;
                    }
                    
                    // Select 10 questions by default, or the max if less than 10
                    if (count === Math.min(10, totalQuestions)) {
                        option.selected = true;
                    }
                    
                    select.appendChild(option);
                });
                
                // Update the help text
                const helpText = document.getElementById('questions-help');
                if (helpText) {
                    helpText.textContent = `${totalQuestions} questions currently available in database`;
                }
                
                console.log(`Updated question count options. ${totalQuestions} questions available.`);
            } else {
                console.warn('Failed to get question count:', data.error);
                // Fallback
                const select = document.getElementById('num-questions');
                select.innerHTML = '<option value="10" selected>10 Questions (estimated)</option>';
            }
        })
        .catch(error => {
            console.error('Error fetching question count:', error);
            // Fallback
            const select = document.getElementById('num-questions');
            select.innerHTML = '<option value="10" selected>10 Questions (fallback)</option>';
        });
}

// Load categories from backend
function loadCategories() {
    return fetch('/api/get_categories')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.categories) {
                const categorySelect = document.getElementById('quiz-category');
                // Clear loading option
                categorySelect.innerHTML = '<option value="All Categories">All Categories</option>';
                
                // Add categories from backend
                data.categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = formatCategoryName(category);
                    categorySelect.appendChild(option);
                });
                
                console.log('Loaded categories:', data.categories);
            } else {
                console.warn('Failed to load categories:', data.error);
                // Remove loading option but keep "All Categories"
                const categorySelect = document.getElementById('quiz-category');
                categorySelect.innerHTML = '<option value="All Categories">All Categories</option>';
            }
        })
        .catch(error => {
            console.error('Error loading categories:', error);
            // Remove loading option but keep "All Categories"
            const categorySelect = document.getElementById('quiz-category');
            categorySelect.innerHTML = '<option value="All Categories">All Categories</option>';
        });
}

// Load difficulty levels from backend
function loadDifficultyLevels() {
    return fetch('/api/get_difficulties')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.difficulties) {
                const difficultySelect = document.getElementById('quiz-difficulty');
                // Clear loading option
                difficultySelect.innerHTML = '<option value="all">All Levels</option>';
                
                // Add difficulties from backend
                data.difficulties.forEach(difficulty => {
                    const option = document.createElement('option');
                    option.value = difficulty;
                    option.textContent = formatDifficultyName(difficulty);
                    difficultySelect.appendChild(option);
                });
                
                console.log('Loaded difficulties:', data.difficulties);
            } else {
                console.warn('Failed to load difficulties:', data.error);
                // Fallback to common difficulty levels
                const difficultySelect = document.getElementById('quiz-difficulty');
                difficultySelect.innerHTML = `
                    <option value="all">All Levels</option>
                    <option value="beginner">Beginner</option>
                    <option value="intermediate">Intermediate</option>
                    <option value="advanced">Advanced</option>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading difficulties:', error);
            // Fallback to common difficulty levels
            const difficultySelect = document.getElementById('quiz-difficulty');
            difficultySelect.innerHTML = `
                <option value="all">All Levels</option>
                <option value="beginner">Beginner</option>
                <option value="intermediate">Intermediate</option>
                <option value="advanced">Advanced</option>
            `;
        });
}

// Format category name for display
function formatCategoryName(category) {
    // Convert snake_case or kebab-case to Title Case
    return category
        .replace(/[-_]/g, ' ')
        .replace(/\b\w/g, l => l.toUpperCase());
}

// Format difficulty name for display
function formatDifficultyName(difficulty) {
    // Capitalize first letter
    return difficulty.charAt(0).toUpperCase() + difficulty.slice(1);
}

// Select quiz mode
function selectMode(mode) {
    console.log('🎯 selectMode() called with mode:', mode);
    
    // Remove previous selection
    document.querySelectorAll('.mode-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    // Find and select the correct mode card
    let selectedCard = null;
    
    document.querySelectorAll('.mode-card').forEach(card => {
        const cardOnclick = card.getAttribute('onclick');
        if (cardOnclick && cardOnclick.includes(`selectMode('${mode}')`)) {
            card.classList.add('selected');
            selectedCard = card;
        }
    });
    
    if (selectedCard) {
        console.log('✅ Mode card selected:', mode);
    } else {
        console.warn('⚠️ Could not find mode card for:', mode);
    }
    
    // Update quiz state
    quizState.mode = mode;
    
    // Show/hide and configure options based on mode
    const numQuestionsGroup = document.getElementById('num-questions-group');
    const numQuestionsSelect = document.getElementById('num-questions');
    
    if (mode === 'exam') {
        // Exam mode has fixed 90 questions
        numQuestionsSelect.value = '90';
        numQuestionsSelect.disabled = true;
        numQuestionsGroup.style.display = 'block';
    } else if (mode === 'survival') {
        // Survival mode has unlimited questions - hide the option
        numQuestionsGroup.style.display = 'none';
    } else {
        // Standard and timed modes allow question customization
        numQuestionsSelect.disabled = false;
        numQuestionsGroup.style.display = 'block';
    }
}

// Start quiz
function startQuiz() {
    console.log('🚀 startQuiz() called');
    
    if (!quizState.mode) {
        console.error('❌ No quiz mode selected');
        showMessage('warning', 'Please select a quiz mode');
        return;
    }
    
    console.log('✅ Quiz mode:', quizState.mode);
    console.log('🔍 Current quizState:', quizState);
    
    const category = document.getElementById('quiz-category').value;
    const difficulty = document.getElementById('quiz-difficulty').value;
    const numQuestions = document.getElementById('num-questions').value;
    
    console.log('📊 Quiz options:', { category, difficulty, numQuestions });
    
    const requestData = {
        mode: quizState.mode,
        category: category,
        difficulty: difficulty
    };

    // Determine the API endpoint based on mode
    let apiEndpoint = '/api/start_quiz';
    console.log('🔍 Switching on mode:', quizState.mode, typeof quizState.mode);
    switch (quizState.mode) {
        case 'timed':
            console.log('🎯 Matched timed mode');
            apiEndpoint = '/api/start_timed_challenge';
            break;
        case 'survival':
            console.log('🎯 Matched survival mode');
            apiEndpoint = '/api/start_survival_mode';
            break;
        case 'exam':
            console.log('🎯 Matched exam mode');
            apiEndpoint = '/api/start_exam_mode';
            break;
        default:
            console.log('🎯 Using default endpoint for mode:', quizState.mode);
            apiEndpoint = '/api/start_quiz';
            break;
    }
    
    console.log('🎯 Final API endpoint:', apiEndpoint);

    // Add number of questions for modes that support it (not survival or exam)
    if (quizState.mode !== 'survival' && quizState.mode !== 'exam') {
        const requestedQuestions = parseInt(numQuestions);
        
        console.log('🔢 Requested questions:', requestedQuestions);
        
        // Check if we have a valid number
        if (isNaN(requestedQuestions) || requestedQuestions <= 0) {
            console.error('❌ Invalid number of questions:', numQuestions);
            showMessage('error', 'Please wait for question options to load, then try again.');
            return;
        }
        
        console.log('✅ Validating question count...');
        
        // Validate the number of questions against available questions
        fetch('/api/get_question_count')
            .then(response => {
                console.log('📡 Question count response status:', response.status);
                return response.json();
            })
            .then(countData => {
                console.log('📊 Question count data:', countData);
                if (countData.success) {
                    const availableQuestions = countData.total_questions;
                    if (requestedQuestions > availableQuestions) {
                        console.warn('⚠️ Too many questions requested. Available:', availableQuestions, 'Requested:', requestedQuestions);
                        showMessage('warning', `Only ${availableQuestions} questions available. Starting quiz with all ${availableQuestions} questions.`);
                        requestData.num_questions = availableQuestions;
                    } else {
                        requestData.num_questions = requestedQuestions;
                    }
                    
                    console.log('✅ Final request data:', requestData);
                    // Continue with the quiz start
                    startQuizWithValidatedData(requestData, apiEndpoint);
                } else {
                    console.warn('⚠️ Could not get question count, proceeding anyway');
                    // If we can't get count, proceed with original request
                    requestData.num_questions = requestedQuestions;
                    startQuizWithValidatedData(requestData, apiEndpoint);
                }
            })
            .catch(error => {
                console.error('❌ Error validating question count:', error);
                // If validation fails, proceed with original request
                requestData.num_questions = requestedQuestions;
                startQuizWithValidatedData(requestData, apiEndpoint);
            });
        return; // Exit here to wait for validation
    }
    
    console.log('🎯 Mode does not require question count validation');
    // For modes that don't need question count validation, start immediately
    startQuizWithValidatedData(requestData, apiEndpoint);
}

// Continue quiz start with validated data
function startQuizWithValidatedData(requestData, apiEndpoint) {
    console.log('Quiz request data:', requestData);
    console.log('Using API endpoint:', apiEndpoint);

    // Show loading state
    showMessage('info', 'Starting quiz...');
    
    // Call the backend API to start the quiz
    fetch(apiEndpoint, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(requestData)
    })
    .then(response => {
        console.log('Raw response status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Start quiz response:', data);
        
        if (data.success) {
            // Track quiz start analytics
            if (typeof trackFeatureUsage === 'function') {
                trackFeatureUsage('quiz_started');
                trackFeatureUsage(`quiz_mode_${quizState.mode}`);
                if (requestData.category && requestData.category !== 'All Categories') {
                    trackFeatureUsage(`quiz_category_${requestData.category}`);
                }
            }
            
            // Update quiz state with backend data
            console.log('🔍 Backend data.total_questions:', data.total_questions);
            quizState.mode = data.mode;
            quizState.totalQuestions = data.total_questions || parseInt(document.getElementById('num-questions').value) || 10;
            console.log('🎯 Final quizState.totalQuestions:', quizState.totalQuestions);
            quizState.currentQuestion = 0;
            quizState.answers = [];
            quizState.startTime = Date.now();
            quizState.score = 0;
            quizState.streak = 0;
            
            // Store mode-specific data
            if (data.survival_mode_active) {
                quizState.survivalLives = data.survival_lives;
            }
            if (data.timed_mode_active) {
                quizState.timePerQuestion = data.time_per_question;
                quizState.timeLimit = data.time_per_question || 30; // Default to 30 seconds
            }
            
            console.log('Updated quiz state:', quizState);
            
            // Update session status to get initial points
            updateSessionStatus();
            
            // Hide setup, show quiz
            document.getElementById('quiz-setup').style.display = 'none';
            document.getElementById('quiz-container').style.display = 'block';
            
            // Initialize mode-specific UI
            initializeModeUI();
            
            // Initialize progress dots AFTER setting totalQuestions from backend
            initializeProgressDots();
            
            // Load first question from backend
            loadQuestionFromBackend();
            
        } else {
            console.error('Start quiz failed:', data.error);
            showMessage('error', data.error || 'Failed to start quiz');
        }
    })
    .catch(error => {
        console.error('Error starting quiz:', error);
        showMessage('error', `Failed to start quiz: ${error.message}`);
    });
}

// Initialize mode-specific UI elements
function initializeModeUI() {
    // Reset all mode displays
    document.getElementById('quiz-timer').style.display = 'none';
    document.getElementById('survival-lives').style.display = 'none';
    
    if (quizState.mode === 'timed' || quizState.mode === 'exam') {
        document.getElementById('quiz-timer').style.display = 'flex';
        startTimer();
    }
    
    if (quizState.mode === 'survival') {
        // Show survival lives indicator
        updateSurvivalLives();
    }
}

// Load question from backend API
function loadQuestionFromBackend() {
    console.log('Loading question from backend...');
    
    fetch('/api/get_question')
        .then(response => {
            console.log('Question response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Question response:', data);
            
            if (data.error) {
                console.error('Question error:', data.error);
                showMessage('error', data.error);
                return;
            }
            
            if (data.quiz_complete) {
                console.log('Quiz completed - showing results');
                showResults();
                return;
            }
            
            // Display the question
            displayQuestionFromBackend(data);
        })
        .catch(error => {
            console.error('Error loading question:', error);
            showMessage('error', `Failed to load question: ${error.message}`);
        });
}

// Display question from backend data
function displayQuestionFromBackend(data) {
    console.log('Displaying question from backend:', data);
    
    // Update question display
    document.getElementById('current-question').textContent = data.question_number || quizState.currentQuestion + 1;
    document.getElementById('total-questions').textContent = data.total_questions || quizState.totalQuestions;
    document.getElementById('question-category').innerHTML = `<i class="fas fa-tag"></i> ${data.category}`;
    document.getElementById('question-text').textContent = data.question;
    
    // Update options
    const optionsContainer = document.getElementById('answer-options');
    optionsContainer.innerHTML = '';
    
    data.options.forEach((option, index) => {
        const optionDiv = document.createElement('div');
        optionDiv.className = 'answer-option';
        optionDiv.innerHTML = `
            <span class="option-letter">${String.fromCharCode(65 + index)}</span>
            <span class="option-text">${option}</span>
            <span class="option-indicator"></span>
        `;
        optionDiv.onclick = () => selectAnswer(index);
        optionsContainer.appendChild(optionDiv);
    });
    
    // Update progress - align with dots by calculating to center of current dot
    const currentQuestionIndex = (data.question_number - 1);
    const totalQuestions = (data.total_questions || quizState.totalQuestions);
    const dotsShown = Math.min(totalQuestions, 20);
    const progressPercentage = dotsShown > 1 
        ? (currentQuestionIndex / (dotsShown - 1)) * 100 
        : currentQuestionIndex === 0 ? 0 : 100;
    document.getElementById('progress-fill').style.width = Math.min(progressPercentage, 100) + '%';
    
    // Update progress dots
    updateProgressDots();
    
    // Reset UI state
    document.getElementById('explanation-box').style.display = 'none';
    document.getElementById('next-btn').style.display = 'none';
    document.getElementById('submit-btn').style.display = 'inline-flex';
    document.getElementById('hint-btn').disabled = false;
    
    // Update mode-specific displays
    if (data.survival_mode_active) {
        quizState.survivalLives = data.survival_lives;
        updateSurvivalLives();
    }
    
    // Reset answer selection
    quizState.selectedAnswer = undefined;
    
    // Reset timer for timed mode
    if (quizState.mode === 'timed') {
        resetTimer();
    }
    
    console.log('Question displayed successfully');
}

// Initialize progress dots
function initializeProgressDots() {
    console.log('🔍 initializeProgressDots called with quizState.totalQuestions:', quizState.totalQuestions);
    const dotsContainer = document.getElementById('progress-dots');
    dotsContainer.innerHTML = '';
    
    const dotsToShow = Math.min(quizState.totalQuestions, 20);
    console.log('🎯 Creating', dotsToShow, 'progress dots');
    for (let i = 0; i < dotsToShow; i++) {
        const dot = document.createElement('div');
        dot.className = 'progress-dot';
        if (i === 0) dot.classList.add('current');
        dotsContainer.appendChild(dot);
    }
}

// Load question
function loadQuestion() {
    const question = sampleQuestions[quizState.currentQuestion % sampleQuestions.length];
    
    // Update question display
    document.getElementById('current-question').textContent = quizState.currentQuestion + 1;
    document.getElementById('total-questions').textContent = quizState.totalQuestions;
    document.getElementById('question-category').innerHTML = `<i class="fas fa-tag"></i> ${question.category}`;
    document.getElementById('question-text').textContent = question.question;
    
    // Update progress - align with dots by calculating to center of current dot
    const dotsShown = Math.min(quizState.totalQuestions, 20);
    const progressPercentage = dotsShown > 1 
        ? (quizState.currentQuestion / (dotsShown - 1)) * 100 
        : quizState.currentQuestion === 0 ? 0 : 100;
    document.getElementById('progress-fill').style.width = Math.min(progressPercentage, 100) + '%';
    
    // Update progress dots
    updateProgressDots();
    
    // Reset answer options
    const optionsContainer = document.getElementById('answer-options');
    optionsContainer.innerHTML = '';
    
    question.options.forEach((option, index) => {
        const optionDiv = document.createElement('div');
        optionDiv.className = 'answer-option';
        optionDiv.onclick = () => selectAnswer(index);
        optionDiv.innerHTML = `
            <span class="option-letter">${String.fromCharCode(65 + index)}</span>
            <span class="option-text">${option}</span>
            <span class="option-indicator"></span>
        `;
        optionsContainer.appendChild(optionDiv);
    });
    
    // Hide explanation and next button
    document.getElementById('explanation-box').style.display = 'none';
    document.getElementById('next-btn').style.display = 'none';
    document.getElementById('submit-btn').style.display = 'inline-flex';
    document.getElementById('hint-btn').disabled = false;
    
    // Reset timer for timed mode
    if (quizState.mode === 'timed') {
        resetTimer();
    }
}

// Update progress dots
function updateProgressDots() {
    const dots = document.querySelectorAll('.progress-dot');
    const dotsToShow = Math.min(quizState.totalQuestions, 20);
    
    dots.forEach((dot, index) => {
        const questionIndex = Math.floor((index / dotsToShow) * quizState.totalQuestions);
        
        dot.classList.remove('current', 'completed');
        
        if (questionIndex < quizState.currentQuestion) {
            dot.classList.add('completed');
        } else if (questionIndex === quizState.currentQuestion) {
            dot.classList.add('current');
        }
    });
}

// Select answer
function selectAnswer(index) {
    // Check if this option is eliminated
    const selectedOption = document.querySelectorAll('.answer-option')[index];
    if (selectedOption.classList.contains('eliminated')) {
        console.log('Cannot select eliminated option');
        return;
    }
    
    // Remove previous selection
    document.querySelectorAll('.answer-option').forEach(option => {
        option.classList.remove('selected');
    });
    
    // Add selection
    selectedOption.classList.add('selected');
    
    // Store selected answer
    quizState.selectedAnswer = index;
}

// Submit answer
function submitAnswer(isTimeout = false) {
    console.log('Submitting answer:', { 
        selected: quizState.selectedAnswer, 
        isTimeout: isTimeout 
    });
    
    // For timeout, set selectedAnswer to -1 to indicate no answer
    if (isTimeout && quizState.selectedAnswer === undefined) {
        quizState.selectedAnswer = -1;
    }
    
    if (quizState.selectedAnswer === undefined) {
        showMessage('warning', 'Please select an answer');
        return;
    }
    
    // Clear timer if running
    if (quizState.timer) {
        clearInterval(quizState.timer);
        quizState.timer = null;
    }
    
    // Calculate time taken for this question
    const questionStartTime = quizState.questionStartTime || Date.now();
    const timeTaken = (Date.now() - questionStartTime) / 1000;
    
    // Submit answer to backend
    fetch('/api/submit_answer', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            answer_index: quizState.selectedAnswer === -1 ? null : quizState.selectedAnswer
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log('Submit answer response:', data);
        
        if (data.error) {
            showMessage('error', data.error);
            return;
        }
        
        // Track analytics for quiz answer
        if (typeof trackQuizAnswer === 'function') {
            trackQuizAnswer(data.correct, timeTaken);
        }
        
        // Track feature usage
        if (typeof trackFeatureUsage === 'function') {
            trackFeatureUsage('quiz_answer_submitted');
            if (isTimeout) {
                trackFeatureUsage('quiz_timeout');
            }
        }
        
        // Update UI based on answer correctness
        const options = document.querySelectorAll('.answer-option');
        options.forEach((option, index) => {
            option.classList.add('disabled');
            option.onclick = null;
            
            if (index === data.correct_answer_index) {
                option.classList.add('correct');
            } else if (index === quizState.selectedAnswer && !data.is_correct) {
                option.classList.add('incorrect');
            }
        });
        
        // Show timeout message if applicable
        if (isTimeout) {
            showMessage('warning', 'Time\'s up! Question marked as incorrect.');
        }
        
        // Update score and streak
        if (data.is_correct) {
            quizState.score += data.points_earned || 10;
            quizState.streak = data.streak || 0;
            
            // Update the points display with server data
            updateSessionStatus();
            
            // Update streak badge
            const streakBadge = document.querySelector('.streak-badge, #streak-counter');
            if (streakBadge) {
                streakBadge.textContent = quizState.streak;
            }
            
            // Show streak indicator for 3+ streak
            if (quizState.streak >= 3) {
                showStreak();
            }
        } else {
            quizState.streak = 0;
            
            // Handle survival mode life loss
            if (data.survival_lives !== undefined) {
                quizState.survivalLives = data.survival_lives;
                updateSurvivalLives();
                
                if (data.survival_game_over) {
                    showSurvivalGameOver(data);
                    return;
                }
            }
        }
        
        // Store answer
        quizState.answers.push({
            question: quizState.currentQuestion,
            selected: quizState.selectedAnswer,
            correct: data.correct_answer_index,
            time: Date.now() - quizState.startTime,
            timeout: isTimeout
        });
        
        console.log('Answer stored - quizState.answers length:', quizState.answers.length);
        console.log('Last answer details:', quizState.answers[quizState.answers.length - 1]);
        
        // Show explanation if provided
        if (data.explanation && quizState.mode === 'standard') {
            document.getElementById('explanation-text').textContent = data.explanation;
            document.getElementById('explanation-box').style.display = 'block';
        }
        
        // Show speed bonus message if applicable
        if (data.speed_bonus) {
            showMessage('success', `Speed bonus: +${data.speed_bonus} points!`);
        }
        
        // Update buttons
        document.getElementById('submit-btn').style.display = 'none';
        document.getElementById('hint-btn').disabled = true;
        
        // Check if quiz is complete
        if (data.session_complete) {
            setTimeout(() => showResults(data), 1000);
        } else {
            document.getElementById('next-btn').style.display = 'inline-flex';
        }
    })
    .catch(error => {
        console.error('Error submitting answer:', error);
        showMessage('error', 'Failed to submit answer');
    });
}

// Next question
function nextQuestion() {
    console.log('Loading next question');
    quizState.currentQuestion++;
    quizState.selectedAnswer = undefined;
    
    // Clear any existing timer
    if (quizState.timer) {
        clearInterval(quizState.timer);
        quizState.timer = null;
    }
    
    loadQuestionFromBackend();
}

// Update survival lives display
function updateSurvivalLives() {
    const livesDisplay = document.getElementById('survival-lives');
    const livesCount = document.getElementById('lives-count');
    
    if (quizState.mode === 'survival' && quizState.survivalLives !== undefined) {
        livesDisplay.style.display = 'flex';
        livesCount.textContent = quizState.survivalLives;
        
        // Add warning class if low on lives
        if (quizState.survivalLives <= 1) {
            livesDisplay.classList.add('warning');
        } else {
            livesDisplay.classList.remove('warning');
        }
    } else {
        livesDisplay.style.display = 'none';
    }
}

// Show survival game over
function showSurvivalGameOver(data) {
    const gameOverHtml = `
        <div class="quiz-complete">
            <div class="complete-header">
                <div class="complete-icon game-over">
                    💀
                </div>
                <h2>Game Over!</h2>
                <p>You ran out of lives in Survival Mode</p>
            </div>
            
            <div class="results-stats">
                <div class="result-stat">
                    <i class="fas fa-trophy" style="color: var(--warning-color);"></i>
                    <div>
                        <h3 id="final-score">${data.survival_final_score || quizState.score}</h3>
                        <p>Final Score</p>
                    </div>
                </div>
                <div class="result-stat">
                    <i class="fas fa-star" style="color: var(--primary-color);"></i>
                    <div>
                        <h3 id="high-score">${data.survival_high_score || 0}</h3>
                        <p>High Score</p>
                    </div>
                </div>
                <div class="result-stat">
                    <i class="fas fa-question" style="color: var(--accent-color);"></i>
                    <div>
                        <h3>${quizState.answers.length}</h3>
                        <p>Questions Answered</p>
                    </div>
                </div>
            </div>

            <div class="results-actions">
                <button class="btn btn-danger" onclick="startNewSurvivalMode()">
                    <i class="fas fa-redo"></i> Try Again
                </button>
                <button class="btn btn-secondary" onclick="window.location.href='/'">
                    <i class="fas fa-home"></i> Home
                </button>
            </div>
        </div>
    `;

    document.getElementById('question-container').innerHTML = gameOverHtml;
    document.getElementById('quiz-container').classList.add('quiz-complete');
}

// Start new survival mode
function startNewSurvivalMode() {
    window.location.reload();
}

// Show message helper
function showMessage(type, message) {
    // Create a simple toast notification
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.textContent = message;
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        color: white;
        font-weight: 600;
        z-index: 10000;
        transition: all 0.3s ease;
    `;
    
    // Set background color based on type
    switch (type) {
        case 'success':
            toast.style.background = 'var(--success-color)';
            break;
        case 'warning':
            toast.style.background = 'var(--warning-color)';
            break;
        case 'error':
            toast.style.background = 'var(--danger-color)';
            break;
        default:
            toast.style.background = 'var(--primary-color)';
    }
    
    document.body.appendChild(toast);
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
        }
    }, 3000);
}

// Use hint
function useHint() {
    const hintPenalty = parseInt(document.getElementById('hint-penalty')?.textContent) || 5;
    if (confirm(`Using a hint will deduct ${hintPenalty} points. Continue?`)) {
        quizState.score = Math.max(0, quizState.score - hintPenalty);
        
        // Get the current question data from the backend
        // We need to fetch the correct answer from the current question
        const currentQuestionElement = document.getElementById('question-text');
        if (!currentQuestionElement || !currentQuestionElement.textContent) {
            showMessage('error', 'No active question for hint');
            return;
        }
        
        // Request hint from backend API
        fetch('/api/get_hint', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.eliminate_indices) {
                // Eliminate the specified wrong answers
                const options = document.querySelectorAll('.answer-option');
                
                data.eliminate_indices.forEach(index => {
                    if (index < options.length) {
                        options[index].style.opacity = '0.3';
                        options[index].classList.add('disabled', 'eliminated');
                        options[index].onclick = null;
                    }
                });
                
                showMessage('info', `Eliminated ${data.eliminate_indices.length} incorrect answers`);
                document.getElementById('hint-btn').disabled = true;
            } else {
                // Fallback: eliminate answers based on current UI state
                eliminateAnswersClientSide();
            }
        })
        .catch(error => {
            console.error('Error getting hint:', error);
            // Fallback: eliminate answers based on current UI state
            eliminateAnswersClientSide();
        });
    }
}

// Fallback function for client-side hint elimination
function eliminateAnswersClientSide() {
    console.log('Using client-side hint fallback');
    
    const options = document.querySelectorAll('.answer-option');
    const totalOptions = options.length;
    
    // Create array of all option indices
    const optionIndices = Array.from({length: totalOptions}, (_, i) => i);
    
    // We don't know the correct answer on client side, so we'll eliminate 2 random options
    // This is not ideal but better than always eliminating the same positions
    const shuffled = optionIndices.sort(() => Math.random() - 0.5);
    const toEliminate = shuffled.slice(0, Math.min(2, totalOptions - 1)); // Leave at least 1 option
    
    toEliminate.forEach(index => {
        options[index].style.opacity = '0.3';
        options[index].classList.add('disabled', 'eliminated');
        options[index].onclick = null;
    });
    
    showMessage('info', `Eliminated ${toEliminate.length} answers (random selection)`);
    document.getElementById('hint-btn').disabled = true;
}

// Timer functions
function startTimer() {
    console.log('Starting timer for timed mode');
    quizState.timeRemaining = quizState.timeLimit;
    updateTimerDisplay();
    
    quizState.timer = setInterval(() => {
        if (!quizState.paused) {
            quizState.timeRemaining--;
            updateTimerDisplay();
            
            if (quizState.timeRemaining <= 0) {
                console.log('Timer expired - auto-submitting answer');
                clearInterval(quizState.timer);
                quizState.timer = null;
                // Auto-submit with timeout flag
                submitAnswer(true);
            }
        }
    }, 1000);
}

function resetTimer() {
    if (quizState.timer) {
        clearInterval(quizState.timer);
        quizState.timer = null;
    }
    if (quizState.mode === 'timed' || quizState.mode === 'exam') {
        startTimer();
    }
}

function updateTimerDisplay() {
    const timerElement = document.getElementById('quiz-timer');
    const timeDisplay = document.getElementById('time-remaining');
    
    timeDisplay.textContent = quizState.timeRemaining;
    
    // Add warning classes
    timerElement.classList.remove('warning', 'danger');
    if (quizState.timeRemaining <= 10) {
        timerElement.classList.add('danger');
    } else if (quizState.timeRemaining <= 20) {
        timerElement.classList.add('warning');
    }
}

// Show streak indicator
function showStreak() {
    const indicator = document.getElementById('streak-indicator');
    document.getElementById('streak-count').textContent = quizState.streak;
    
    indicator.style.display = 'flex';
    setTimeout(() => {
        indicator.style.display = 'none';
    }, 2000);
}

// Pause quiz
function pauseQuiz() {
    quizState.paused = true;
    document.getElementById('pause-modal').classList.add('active');
}

// Resume quiz
function resumeQuiz() {
    quizState.paused = false;
    document.getElementById('pause-modal').classList.remove('active');
}

// End quiz
function endQuiz() {
    console.log('End quiz requested');
    
    if (confirm('Are you sure you want to end the quiz?')) {
        console.log('User confirmed end quiz');
        
        // Clear any running timer
        if (quizState.timer) {
            clearInterval(quizState.timer);
            quizState.timer = null;
        }
        
        // Call backend to end the session
        fetch('/api/end_quiz', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            console.log('End quiz response:', data);
            if (data.success) {
                showResults(data);
            } else {
                console.error('Failed to end quiz:', data.error);
                // Still show results even if backend fails
                showResults();
            }
        })
        .catch(error => {
            console.error('Error ending quiz:', error);
            // Still show results even if request fails
            showResults();
        });
    }
}

// Show results
function showResults(backendData = null) {
    clearInterval(quizState.timer);
    
    if (backendData && backendData.success === false) {
        showMessage('error', backendData.error || 'Failed to get quiz results');
        return;
    }
    
    // If we have backend data, use it; otherwise fetch from API
    if (backendData) {
        displayResultsWithData(backendData);
    } else {
        // Fetch results from backend API
        fetch('/api/quiz_results')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayResultsWithData(data);
                } else {
                    // Fallback to end quiz API if no results available
                    return fetch('/api/end_quiz', { method: 'POST' });
                }
            })
            .then(response => {
                if (response) {
                    return response.json();
                }
            })
            .then(data => {
                if (data && data.success) {
                    displayResultsWithData(data);
                } else {
                    // Last resort: calculate from frontend data
                    displayResultsWithFrontendData();
                }
            })
            .catch(error => {
                console.error('Error fetching quiz results:', error);
                displayResultsWithFrontendData();
            });
    }
}

// Display results using backend data
function displayResultsWithData(data) {
    console.log('Displaying results with backend data:', data);
    console.log('Current quizState.answers:', quizState.answers);
    
    // IMPORTANT: Always use session-specific data, never cumulative user stats
    // Extract results from backend session data - prioritize backend session data
    const sessionScore = data.session_score !== undefined ? data.session_score : 
                         (quizState.answers ? quizState.answers.filter(a => a.selected === a.correct).length : 0);
    const sessionTotal = data.session_total !== undefined ? data.session_total : 
                         (quizState.answers ? quizState.answers.length : 1);
    
    console.log('Session-specific scores - sessionScore:', sessionScore, 'sessionTotal:', sessionTotal);
    
    // Validation: Ensure we're not showing cumulative stats
    if (sessionScore > sessionTotal) {
        console.error('ERROR: Session score exceeds session total - likely showing cumulative stats!');
        console.error('Data received:', data);
        showMessage('error', 'Quiz results error: Invalid session data detected');
        return;
    }
    
    // Additional validation: reasonable session totals
    if (sessionTotal > 100) {
        console.warn('WARNING: Unusually high session total, may be cumulative data');
    }
    
    // Calculate accuracy based on session data only
    const accuracy = data.accuracy !== undefined ? data.accuracy : 
                    sessionTotal > 0 ? (sessionScore / sessionTotal * 100) : 0;
    const correct = sessionScore;
    const incorrect = sessionTotal - correct;
    const percentage = Math.round(accuracy);
    
    // Calculate time
    let timeTaken = 0;
    if (data.duration) {
        timeTaken = Math.floor(data.duration);
    } else if (data.session_time) {
        timeTaken = Math.floor(data.session_time);
    } else if (quizState.startTime) {
        timeTaken = Math.floor((Date.now() - quizState.startTime) / 1000);
    }
    
    const minutes = Math.floor(timeTaken / 60);
    const seconds = timeTaken % 60;
    
    // Points
    const points = data.session_points || data.points_earned || quizState.score || 0;
    
    // Hide quiz, show results
    document.getElementById('quiz-container').style.display = 'none';
    document.getElementById('quiz-results').style.display = 'block';
    
    // Update results display
    document.getElementById('score-percent').textContent = percentage + '%';
    document.getElementById('correct-count').textContent = correct;
    document.getElementById('incorrect-count').textContent = incorrect;
    document.getElementById('time-taken').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    document.getElementById('points-earned').textContent = points;
    
    // Animate score ring
    const circumference = 2 * Math.PI * 90;
    const offset = circumference - (percentage / 100 * circumference);
    
    setTimeout(() => {
        const scoreRing = document.querySelector('.score-ring');
        if (scoreRing) {
            scoreRing.style.strokeDashoffset = offset;
        }
    }, 100);
    
    // Save results
    saveQuizResults({
        mode: quizState.mode || data.mode,
        score: percentage,
        correct: correct,
        incorrect: incorrect,
        time: timeTaken,
        points: points,
        total: sessionTotal
    });
}

// Fallback: Display results using frontend data (when backend fails)
function displayResultsWithFrontendData() {
    console.log('Displaying results with frontend fallback data');
    
    // Calculate results from frontend state
    const correct = quizState.answers ? quizState.answers.filter(a => a.selected === a.correct).length : 0;
    const total = quizState.totalQuestions || quizState.answers.length || 1;
    const incorrect = total - correct;
    const percentage = Math.round((correct / total) * 100);
    const timeTaken = quizState.startTime ? Math.floor((Date.now() - quizState.startTime) / 1000) : 0;
    const minutes = Math.floor(timeTaken / 60);
    const seconds = timeTaken % 60;
    
    // Hide quiz, show results
    document.getElementById('quiz-container').style.display = 'none';
    document.getElementById('quiz-results').style.display = 'block';
    
    // Update results display
    document.getElementById('score-percent').textContent = percentage + '%';
    document.getElementById('correct-count').textContent = correct;
    document.getElementById('incorrect-count').textContent = incorrect;
    document.getElementById('time-taken').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    document.getElementById('points-earned').textContent = quizState.score || 0;
    
    // Animate score ring
    const circumference = 2 * Math.PI * 90;
    const offset = circumference - (percentage / 100 * circumference);
    
    setTimeout(() => {
        const scoreRing = document.querySelector('.score-ring');
        if (scoreRing) {
            scoreRing.style.strokeDashoffset = offset;
        }
    }, 100);
    
    // Save results
    saveQuizResults({
        mode: quizState.mode,
        score: percentage,
        correct: correct,
        incorrect: incorrect,
        time: timeTaken,
        points: quizState.score || 0,
        total: total
    });
}

// Save quiz results
function saveQuizResults(results) {
    const history = JSON.parse(localStorage.getItem('quizHistory') || '[]');
    history.push({
        ...results,
        date: new Date().toISOString()
    });
    localStorage.setItem('quizHistory', JSON.stringify(history));
    
    // Update stats
    const stats = JSON.parse(localStorage.getItem('gameStats') || '{}');
    stats.totalQuizzes = (stats.totalQuizzes || 0) + 1;
    stats.totalCorrect = (stats.totalCorrect || 0) + results.correct;
    stats.totalQuestions = (stats.totalQuestions || 0) + quizState.totalQuestions;
    stats.totalPoints = (stats.totalPoints || 0) + results.points;
    localStorage.setItem('gameStats', JSON.stringify(stats));
}

// Review answers
function reviewAnswers() {
    // Navigate to the review page
    window.location.href = '/review';
}

// Start new quiz
function startNewQuiz() {
    location.reload();
}

// Share results
function shareResults() {
    const text = `I scored ${document.getElementById('score-percent').textContent} on the Linux+ Study Game! Can you beat my score?`;
    
    if (navigator.share) {
        navigator.share({
            title: 'Linux+ Study Game Results',
            text: text,
            url: window.location.href
        });
    } else {
        // Copy to clipboard
        navigator.clipboard.writeText(text);
        showMessage('success', 'Results copied to clipboard!');
    }
}

// This should be in your quiz.html or quiz completion handler
fetch('/api/quiz/complete', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
    },
    body: JSON.stringify({
        correct: 9,
        incorrect: 1,
        time_taken: 33,
        points: 110,
        accuracy: 90
    })
})
</script>
{% endblock %}